{% extends "base.html" %}
{% block title %}ì„œë¥˜ ë³´ë‚´ê¸°{% endblock %}

{% block content %}
<style>
  .doc-card{max-width:880px;margin:24px auto;padding:28px;border-radius:16px;
            background:#fff;box-shadow:0 6px 24px rgba(0,0,0,.06);}
  .doc-title{font-size:32px;font-weight:800;margin:4px 0 22px 0;display:flex;gap:12px;align-items:center}
  .doc-title .emoji{font-size:28px}
  .hint{color:#47616b;background:#edf7f3;border:1px solid #d7efe5;padding:12px 14px;border-radius:12px;margin-bottom:18px}
  .field{margin:14px 0}
  label{display:block;font-weight:700;margin-bottom:8px}
  input[type="text"], textarea{
    width:100%;padding:12px 14px;border:1px solid #e4e7ec;border-radius:12px;font-size:15px;
    outline:none;background:#fafafa
  }
  textarea{min-height:220px;resize:vertical}
  .file-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .file-chip{
    display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #e4e7ec;border-radius:999px;
    background:#f7f8fb;font-size:14px;margin:6px 6px 0 0
  }
  .file-chip button{border:none;background:transparent;cursor:pointer;font-size:16px;line-height:1}
  .actions{display:flex;gap:10px;margin-top:12px}
  .btn{padding:12px 16px;border-radius:12px;border:1px solid transparent;cursor:pointer;font-weight:700}
  .btn-primary{background:#2f7dff;color:#fff}
  .btn-primary[disabled]{opacity:.6;cursor:not-allowed}
  .btn-ghost{background:#eef2f7;color:#1f2a37}
  .flash{margin:-6px auto 18px auto;max-width:880px}
  .flash .ok{background:#e8f7e9;border:1px solid #bfe7c4;color:#236a2b;padding:10px 12px;border-radius:12px}
  .flash .error{background:#ffecec;border:1px solid #ffc7c7;color:#9b2222;padding:10px 12px;border-radius:12px}
  .subtle{color:#6b7280;font-size:14px;margin-top:6px}
</style>

<div class="flash">
  {% with msgs=get_flashed_messages(with_categories=true) %}
    {% if msgs %}
      {% for cat, m in msgs %}
        <div class="{{ 'ok' if cat=='success' else 'error' }}">{{ m }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<div class="doc-card">
  <div class="doc-title"><span class="emoji">ğŸ“¤</span>ì„œë¥˜ ë³´ë‚´ê¸°</div>
  <div class="hint">ë©”ì¼ë¡œ íŒŒì¼ì„ ì „ì†¡í•©ë‹ˆë‹¤. ì—¬ëŸ¬ ê°œë¥¼ ê³ ë¥¼ ìˆ˜ ìˆìœ¼ë©°, ë¦¬ìŠ¤íŠ¸ì—ì„œ ê°œë³„ ì‚­ì œë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>

  <form id="send-form" method="post" enctype="multipart/form-data">
    {{ csrf_token() if csrf_token }}
    <div class="field">
      <label for="to">To</label>
      <input id="to" name="to" type="text" placeholder="a@a.com, b@b.com" required>
    </div>
    <div class="field">
      <label for="subject">ì œëª©</label>
      <input id="subject" name="subject" type="text" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
    </div>
    <div class="field">
      <label for="body">ë³¸ë¬¸</label>
      <textarea id="body" name="body" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”â€¦"></textarea>
    </div>

    <div class="field">
      <label>íŒŒì¼</label>
      <div class="file-row">
        <input id="file-input" name="files" type="file" multiple>
        <div class="subtle">ì„ íƒëœ íŒŒì¼</div>
      </div>
      <div id="file-list" class="file-row" aria-live="polite"></div>
    </div>

    <div class="actions">
      <button id="send-btn" class="btn btn-primary" type="submit">ğŸ“¨ ë³´ë‚´ê¸°</button>
      <a class="btn btn-ghost" href="{{ url_for('docs_home') }}">ğŸ  ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <div id="sending" class="subtle" style="display:none">â³ ë©”ì¼ì„ ë³´ë‚´ëŠ” ì¤‘â€¦</div>
  </form>
</div>

<script>
  // ---- ë©€í‹° íŒŒì¼ ìœ ì§€/ê°œë³„ì‚­ì œ: DataTransfer í™œìš© ----
  const input = document.getElementById('file-input');
  const list  = document.getElementById('file-list');
  let store   = new DataTransfer();

  function renderList(){
    list.innerHTML = "";
    if (store.files.length === 0){
      const empty = document.createElement('div');
      empty.className = 'subtle';
      empty.textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
      list.appendChild(empty);
      return;
    }
    Array.from(store.files).forEach((f, idx) => {
      const chip = document.createElement('div');
      chip.className = 'file-chip';
      chip.innerHTML  = `<span>${f.name}</span>
                         <button type="button" aria-label="ì‚­ì œ" data-idx="${idx}">âœ•</button>`;
      list.appendChild(chip);
    });
  }
  renderList();

  input.addEventListener('change', () => {
    // ìƒˆë¡œ ê³ ë¥¸ íŒŒì¼ì„ ê¸°ì¡´ ëª©ë¡ì— ì¶”ê°€
    for (const f of input.files) store.items.add(f);
    input.files = store.files; // form ì œì¶œ ì‹œ ì´ ê°’ì´ ì „ì†¡ë¨
    renderList();
  });

  list.addEventListener('click', (e) => {
    if (!e.target.matches('button[data-idx]')) return;
    const rm = +e.target.dataset.idx;
    const next = new DataTransfer();
    Array.from(store.files).forEach((f, i) => { if (i !== rm) next.items.add(f); });
    store = next;
    input.files = store.files;
    renderList();
  });

  // ---- ì „ì†¡ UX: ìŠ¤í”¼ë„ˆ/ë²„íŠ¼ ì ê¸ˆ ----
  const form = document.getElementById('send-form');
  const btn  = document.getElementById('send-btn');
  const sending = document.getElementById('sending');

  form.addEventListener('submit', () => {
    btn.disabled = true;
    btn.textContent = "â³ ë³´ë‚´ëŠ” ì¤‘â€¦";
    sending.style.display = "block";
  });
</script>
{% endblock %}
