{% extends "base.html" %}
{% block title %}서류 보내기{% endblock %}

{% block content %}
<style>
  .doc-card{max-width:880px;margin:24px auto;padding:28px;border-radius:16px;
            background:#fff;box-shadow:0 6px 24px rgba(0,0,0,.06);}
  .doc-title{font-size:32px;font-weight:800;margin:4px 0 22px 0;display:flex;gap:12px;align-items:center}
  .doc-title .emoji{font-size:28px}
  .hint{color:#47616b;background:#edf7f3;border:1px solid #d7efe5;padding:12px 14px;border-radius:12px;margin-bottom:18px}
  .field{margin:14px 0}
  label{display:block;font-weight:700;margin-bottom:8px}
  input[type="text"], textarea{
    width:100%;padding:12px 14px;border:1px solid #e4e7ec;border-radius:12px;font-size:15px;
    outline:none;background:#fafafa
  }
  textarea{min-height:220px;resize:vertical}
  .file-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .file-chip{
    display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #e4e7ec;border-radius:999px;
    background:#f7f8fb;font-size:14px;margin:6px 6px 0 0
  }
  .file-chip button{border:none;background:transparent;cursor:pointer;font-size:16px;line-height:1}
  .actions{display:flex;gap:10px;margin-top:12px}
  .btn{padding:12px 16px;border-radius:12px;border:1px solid transparent;cursor:pointer;font-weight:700}
  .btn-primary{background:#2f7dff;color:#fff}
  .btn-primary[disabled]{opacity:.6;cursor:not-allowed}
  .btn-ghost{background:#eef2f7;color:#1f2a37}
  .flash{margin:-6px auto 18px auto;max-width:880px}
  .flash .ok{background:#e8f7e9;border:1px solid #bfe7c4;color:#236a2b;padding:10px 12px;border-radius:12px}
  .flash .error{background:#ffecec;border:1px solid #ffc7c7;color:#9b2222;padding:10px 12px;border-radius:12px}
  .subtle{color:#6b7280;font-size:14px;margin-top:6px}
</style>

<div class="flash">
  {% with msgs=get_flashed_messages(with_categories=true) %}
    {% if msgs %}
      {% for cat, m in msgs %}
        <div class="{{ 'ok' if cat=='success' else 'error' }}">{{ m }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<div class="doc-card">
  <div class="doc-title"><span class="emoji">📤</span>서류 보내기</div>
  <div class="hint">메일로 파일을 전송합니다. 여러 개를 고를 수 있으며, 리스트에서 개별 삭제도 가능합니다.</div>

  <form id="send-form" method="post" enctype="multipart/form-data">
    {{ csrf_token() if csrf_token }}
    <div class="field">
      <label for="to">To</label>
      <input id="to" name="to" type="text" placeholder="a@a.com, b@b.com" required>
    </div>
    <div class="field">
      <label for="subject">제목</label>
      <input id="subject" name="subject" type="text" placeholder="제목을 입력하세요" required>
    </div>
    <div class="field">
      <label for="body">본문</label>
      <textarea id="body" name="body" placeholder="내용을 입력하세요…"></textarea>
    </div>

    <div class="field">
      <label>파일</label>
      <div class="file-row">
        <input id="file-input" name="files" type="file" multiple>
        <div class="subtle">선택된 파일</div>
      </div>
      <div id="file-list" class="file-row" aria-live="polite"></div>
    </div>

    <div class="actions">
      <button id="send-btn" class="btn btn-primary" type="submit">📨 보내기</button>
      <a class="btn btn-ghost" href="{{ url_for('docs_home') }}">🏠 메인으로 돌아가기</a>
    </div>

    <div id="sending" class="subtle" style="display:none">⏳ 메일을 보내는 중…</div>
  </form>
</div>

<script>
  // ---- 멀티 파일 유지/개별삭제: DataTransfer 활용 ----
  const input = document.getElementById('file-input');
  const list  = document.getElementById('file-list');
  let store   = new DataTransfer();

  function renderList(){
    list.innerHTML = "";
    if (store.files.length === 0){
      const empty = document.createElement('div');
      empty.className = 'subtle';
      empty.textContent = '선택된 파일 없음';
      list.appendChild(empty);
      return;
    }
    Array.from(store.files).forEach((f, idx) => {
      const chip = document.createElement('div');
      chip.className = 'file-chip';
      chip.innerHTML  = `<span>${f.name}</span>
                         <button type="button" aria-label="삭제" data-idx="${idx}">✕</button>`;
      list.appendChild(chip);
    });
  }
  renderList();

  input.addEventListener('change', () => {
    // 새로 고른 파일을 기존 목록에 추가
    for (const f of input.files) store.items.add(f);
    input.files = store.files; // form 제출 시 이 값이 전송됨
    renderList();
  });

  list.addEventListener('click', (e) => {
    if (!e.target.matches('button[data-idx]')) return;
    const rm = +e.target.dataset.idx;
    const next = new DataTransfer();
    Array.from(store.files).forEach((f, i) => { if (i !== rm) next.items.add(f); });
    store = next;
    input.files = store.files;
    renderList();
  });

  // ---- 전송 UX: 스피너/버튼 잠금 ----
  const form = document.getElementById('send-form');
  const btn  = document.getElementById('send-btn');
  const sending = document.getElementById('sending');

  form.addEventListener('submit', () => {
    btn.disabled = true;
    btn.textContent = "⏳ 보내는 중…";
    sending.style.display = "block";
  });
</script>
{% endblock %}
