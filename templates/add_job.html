<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‘ì—… ë“±ë¡</title>
  <style>
    :root{ --border:#e5e7eb; --muted:#6b7280; --blue:#2563eb; --green:#16a34a; --red:#ef4444;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'ë§‘ì€ ê³ ë”•',sans-serif; max-width:720px; margin:36px auto; padding:20px; background:#f8f9fb;}
    h2{margin:0 0 16px; text-align:center;}
    .card{background:#fff; border:1px solid var(--border); border-radius:12px; padding:18px;}
    label{display:block; font-weight:700; margin-top:14px;}
    input,select,textarea{width:100%; box-sizing:border-box; margin-top:6px; padding:9px 10px; border:1px solid var(--border); border-radius:8px; font-size:14px; background:#fff;}
    textarea{height:80px; resize:vertical;}
    .row{display:flex; gap:10px;}
    .row > *{flex:1;}
    .actions{display:flex; gap:10px; justify-content:space-between; margin-top:18px; align-items:center;}
    .btn{border:none; border-radius:8px; padding:10px 14px; font-size:14px; cursor:pointer; text-decoration:none;}
    .btn-next{background:var(--blue); color:#fff;}
    .btn-prev{background:#eef2f7; color:#111827;}
    .btn-submit{background:var(--green); color:#fff;}
    .btn-ghost{background:#eef2f7; color:#111827;}
    .btn-grow{flex:1;}
    .hint{font-size:12px; color:var(--muted); margin-top:4px;}

    .steps{display:flex; gap:6px; justify-content:center; margin-bottom:12px; flex-wrap:wrap;}
    .dot{min-width:26px; height:26px; padding:0 8px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-size:12px; border:1px solid var(--border); background:#fff; color:#111;}
    .dot.on{background:var(--blue); color:#fff; border-color:var(--blue);}
    .step{display:none;}
    .step.active{display:block;}
    .inline-selects{display:flex; gap:10px;}
    .inline-selects select{flex:1;}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media (max-width:560px){ .two{grid-template-columns:1fr;} }

    .chk-line{display:flex; align-items:center; gap:8px; margin-top:8px; white-space:nowrap;}
    .chk-inline{display:inline-flex; align-items:center; gap:6px; white-space:nowrap;}
    .spare-inline{display:inline-flex; align-items:center; gap:6px; white-space:nowrap; flex:0 0 auto;}
    .chk-save{margin-top:6px; display:inline-flex; align-items:center; gap:6px; white-space:nowrap;}
    .row-between{display:flex; align-items:center; justify-content:space-between; gap:10px;}

    .tag-blue{display:inline-block;padding:2px 6px;border-radius:8px;background:#e6f0ff;color:#1d4ed8;font-size:12px;}
    .tag-purple{display:inline-block;padding:2px 6px;border-radius:8px;background:#ede9fe;color:#6d28d9;font-size:12px;}

    .relative{position:relative;}
    .sug{position:absolute; left:0; right:0; top:100%; background:#fff; border:1px solid var(--border); border-radius:8px; box-shadow:0 6px 16px rgba(0,0,0,.06); max-height:220px; overflow:auto; z-index:40; margin-top:6px; display:none;}
    .sug.show{display:block;}
    .sug div{padding:8px 10px; cursor:pointer;}
    .sug div:hover{background:#f3f4f6;}
    .readonly-like{ background:#f3f4f6; color:#6b7280; }
  </style>
</head>
<body>
  {% set prev = prev if prev is defined else {} %}
  <h2>ì‘ì—… ë“±ë¡</h2>
  <div style="display:flex;justify-content:flex-end;max-width:720px;margin:0 auto 8px;">
    <button type="button" class="btn btn-ghost" id="resetBtn">ì´ˆê¸°í™”</button>
  </div>

  {% if error %}
    <div class="card" style="border-color:#fca5a5; background:#fff1f2; color:#991b1b; margin-bottom:12px;">
      {{ error }}
    </div>
  {% endif %}

  <div class="steps" id="stepsBar">
    <span class="dot on">1</span><span class="dot">2</span><span class="dot">3</span><span class="dot">4</span>
    <span class="dot">5</span><span class="dot">6</span><span class="dot">7</span><span class="dot">8</span><span class="dot">9</span>
  </div>

  <form id="jobForm" method="POST" autocomplete="off" class="card">
    <!-- 1 ë‚ ì§œ -->
    <div class="step active" data-step="1">
      <label for="date">ë‚ ì§œ</label>
      <input type="date" id="date" name="date" value="{{ prev.get('date','') }}" required>
      <div class="actions"><span></span><button type="button" class="btn btn-next" onclick="nextStep()">ë‹¤ìŒ</button></div>
    </div>

    <!-- 2 ì‹œê°„ -->
    <div class="step" data-step="2">
      <label>ì‹œê°„ ì„ íƒ</label>
      <div class="inline-selects">
        <select id="hour" name="hour">
          <option value="">ì‹œ</option>
          {% for h in range(0,24) %}{% set hh = "%02d"|format(h) %}
            <option value="{{ hh }}" {{ 'selected' if prev.get('hour','')==hh else '' }}>{{ hh }} ì‹œ</option>
          {% endfor %}
        </select>
        <select id="minute" name="minute">
          <option value="">ë¶„</option>
          {% for m in [0,10,20,30,40,50] %}{% set mm = "%02d"|format(m) %}
            <option value="{{ mm }}" {{ 'selected' if prev.get('minute','')==mm else '' }}>{{ mm }} ë¶„</option>
          {% endfor %}
        </select>
      </div>
      <div class="hint">ì œì¶œ ì‹œ <code>HH:MM</code> ìœ¼ë¡œ í•©ì³ ì €ì¥ë©ë‹ˆë‹¤.</div>
      <div class="actions">
        <button type="button" class="btn btn-prev" onclick="prevStep()">ì´ì „</button>
        <button type="button" class="btn btn-next" onclick="nextStep()">ë‹¤ìŒ</button>
      </div>
    </div>

    <!-- 3 ê¸°ì‚¬ -->
    <div class="step" data-step="3">
      <label>ê¸°ì‚¬ ì„ íƒ ë˜ëŠ” ì§ì ‘ì…ë ¥</label>
      <select id="worker_select" onchange="document.getElementById('worker_input').value=this.value;">
        <option value="">ì„ íƒ ì•ˆí•¨</option>
        {% for worker in workers %}<option value="{{ worker['name'] }}">{{ worker['name'] }}</option>{% endfor %}
      </select>
      <div class="chk-line">
        <input type="text" id="worker_input" name="worker" value="{{ prev.get('worker','') }}" placeholder="ê¸°ì‚¬ëª… ì§ì ‘ì…ë ¥">
        <label class="spare-inline" for="spare_cb"><input id="spare_cb" type="checkbox" name="is_spare" value="1" {{ 'checked' if prev.get('is_spare') else '' }}> ìŠ¤í˜ì–´</label>
      </div>
      <div class="actions">
        <button type="button" class="btn btn-prev" onclick="prevStep()">ì´ì „</button>
        <a class="btn btn-ghost" href="{{ url_for('add_worker') }}?from=add_job">ê¸°ì‚¬ ë“±ë¡/ê´€ë¦¬</a>
        <button type="button" class="btn btn-next" onclick="nextStep()">ë‹¤ìŒ</button>
      </div>
    </div>

    <!-- 4 ì¥ë¹„ -->
    <div class="step" data-step="4">
      <label>ì¥ë¹„ ì„ íƒ ë˜ëŠ” ì§ì ‘ì…ë ¥</label>
      <select onchange="
        var o=this.options[this.selectedIndex];
        document.getElementById('machine_name_input').value=o.dataset.name||'';
        document.getElementById('machine_number_input').value=o.dataset.number||'';
        document.getElementById('machine_alias_input').value=o.dataset.alias||'';
      ">
        <option value="">ì„ íƒ ì•ˆí•¨</option>
        {% for m in machines %}<option data-name="{{ m.name }}" data-number="{{ m.number }}" data-alias="{{ m.alias }}">{{ m.name }} / {{ m.number }}{% if m.alias %} / {{ m.alias }}{% endif %}</option>{% endfor %}
      </select>
      <div class="two">
        <input type="text" id="machine_name_input" name="machine_name_input"  value="{{ prev.get('machine_name_input','') }}" placeholder="ì¥ë¹„ëª…">
        <input type="text" id="machine_number_input" name="machine_number_input" value="{{ prev.get('machine_number_input','') }}" placeholder="ì°¨ëŸ‰ë²ˆí˜¸">
      </div>
      <input type="text" id="machine_alias_input" name="machine_alias_input" value="{{ prev.get('machine_alias_input','') }}" placeholder="ë³„ì¹­/ì—°ì‹(ì„ íƒ)">
      <div class="actions">
        <button type="button" class="btn btn-prev" onclick="prevStep()">ì´ì „</button>
        <a class="btn btn-ghost" href="{{ url_for('manage_machines') }}?from=add_job">ì¥ë¹„ ê´€ë¦¬</a>
        <button type="button" class="btn btn-next" onclick="nextStep()">ë‹¤ìŒ</button>
      </div>
    </div>

    <!-- 5 ê±°ë˜ì²˜ -->
    <div class="step" data-step="5">
      <label>ë°œì£¼ì(ì›ìˆ˜ê¸‰ì)</label>
      <input list="owners_datalist" name="client_primary" value="{{ prev.get('client_primary','') }}" placeholder="ì˜ˆ: í™ì˜ˆâ€¦">
      <datalist id="owners_datalist">{% for o in owners %}<option value="{{ o }}"></option>{% endfor %}</datalist>
      <label class="chk-save"><input type="checkbox" name="save_owner" value="1"> ë‚´ ê±°ë˜ì²˜ì— ì €ì¥</label>

      <div class="row-between" style="margin-top:14px;">
        <label style="margin:0;">ê±´ì„¤ì—…ì(ì„ì°¨ì¸)</label>
        <label class="chk-inline" for="same_as_owner"><input id="same_as_owner" type="checkbox" name="same_as_owner" value="1"> ì›ìˆ˜ê¸‰ìì™€ ë™ì¼</label>
      </div>
      <input list="tenants_datalist" id="tenant_input" name="client_tenant" value="{{ prev.get('client_tenant','') }}" placeholder="ì˜ˆ: ê°€ë‚˜ë‹¤â€¦">
      <datalist id="tenants_datalist">{% for t in tenants %}<option value="{{ t }}"></option>{% endfor %}</datalist>
      <label class="chk-save"><input type="checkbox" name="save_tenant" value="1"> ë‚´ ê±°ë˜ì²˜ì— ì €ì¥</label>

      <div class="actions">
        <button type="button" class="btn btn-prev" onclick="prevStep()">ì´ì „</button>
        <a class="btn btn-ghost" href="{{ url_for('manage_clients') }}?from=add_job">ê±°ë˜ì²˜ ê´€ë¦¬</a>
        <button type="button" class="btn btn-next" onclick="nextStep()">ë‹¤ìŒ</button>
      </div>
    </div>

    <!-- 6 ìœ„ì¹˜ -->
    <div class="step" data-step="6">
      <label>ì‘ì—… ìœ„ì¹˜ (ì§ì ‘ ì…ë ¥)</label>
      <div class="relative">
        <input type="text" id="location_input" name="location" value="{{ prev.get('location','') }}" placeholder="ì˜ˆ: ìˆ˜ì› â—‹â—‹í˜„ì¥">
        <div id="locSug" class="sug"></div>
      </div>
      <div class="hint">ìµœê·¼ ì…ë ¥í–ˆë˜ ì£¼ì†Œ ìµœëŒ€ 20ê°œê°€ ìë™ì™„ì„±ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div class="actions">
        <button type="button" class="btn btn-prev" onclick="prevStep()">ì´ì „</button>
        <button type="button" class="btn btn-next" onclick="nextStep()">ë‹¤ìŒ</button>
      </div>
    </div>

    <!-- 7 ê¸°ê°„ -->
    <div class="step" data-step="7">
      <label for="duration_type">ì‘ì—… ê¸°ê°„</label>
      <select id="duration_type" name="duration_type">
        {% set dt = prev.get('duration_type','í•˜ë£¨') %}
        <option value="í•˜ë£¨"   {{ 'selected' if dt=='í•˜ë£¨' else '' }}>í•˜ë£¨</option>
        <option value="ë°˜ë‚˜ì ˆ" {{ 'selected' if dt=='ë°˜ë‚˜ì ˆ' else '' }}>ë°˜ë‚˜ì ˆ</option>
        <option value="Nì‹œê°„"  {{ 'selected' if dt=='Nì‹œê°„' else '' }}>Nì‹œê°„</option>
      </select>
      <select id="duration_hours" name="duration_hours" style="display:none;margin-top:8px;">
        {% set dh = prev.get('duration_hours','') %}
        {% for n in range(1,25) %}<option value="{{ n }}" {{ 'selected' if (dh|string)==(n|string) else '' }}>{{ n }}</option>{% endfor %}
      </select>
      <div class="actions">
        <button type="button" class="btn btn-prev" onclick="prevStep()">ì´ì „</button>
        <button type="button" class="btn btn-next" onclick="nextStep()">ë‹¤ìŒ</button>
      </div>
    </div>

    <!-- 8 ê¸ˆì•¡/ê³µìœ  -->
    <div class="step" data-step="8">
      <label for="amount_man">ê¸ˆì•¡ (ë§Œì›)</label>
      <input type="number" id="amount_man" name="amount_man" min="0" step="1" value="{{ prev.get('amount_man','') }}" placeholder="ì˜ˆ: 35">
      <label class="chk-save"><input type="checkbox" id="share_amount" name="share_amount" value="1" {{ 'checked' if prev.get('share_amount') else '' }}> ê¸ˆì•¡ì„ ê¸°ì‚¬ì—ê²Œ ê³µìœ </label>
      <div class="actions">
        <button type="button" class="btn btn-prev" onclick="prevStep()">ì´ì „</button>
        <button type="button" class="btn btn-next" onclick="nextStep()">ë‹¤ìŒ</button>
      </div>
    </div>

    <!-- 9 ì™¸ì£¼/ìš”ì²­ì‚¬í•­ + ì œì¶œ -->
    <div class="step" data-step="9">
      <label>ì™¸ì£¼</label>
      <div class="row">
        <label class="chk-line" style="flex:unset;"><input type="radio" name="outsource_type" value="none"     {{ 'checked' if prev.get('outsource_type','none')=='none' else '' }}> ì—†ìŒ</label>
        <label class="chk-line" style="flex:unset;"><input type="radio" name="outsource_type" value="received" {{ 'checked' if prev.get('outsource_type')=='received' else '' }}> ë°›ìŒ <span class="tag-blue">ì™¸ì£¼</span></label>
        <label class="chk-line" style="flex:unset;"><input type="radio" name="outsource_type" value="given"    {{ 'checked' if prev.get('outsource_type')=='given' else '' }}> ì¤¬ìŒ <span class="tag-purple">ì™¸ì£¼</span></label>
      </div>
      <input type="text" name="outsource_partner" value="{{ prev.get('outsource_partner','') }}" placeholder="ì™¸ì£¼ ì—…ì²´ëª… (ì˜ˆ: ê°€ë‚˜ë‹¤í¬ë ˆì¸)">
      <label>ìš”ì²­ì‚¬í•­</label>
      <textarea name="note">{{ prev.get('note','') }}</textarea>
      <div class="actions" style="margin-top:12px;">
        <button type="button" class="btn btn-prev" onclick="prevStep()">ì´ì „</button>
        <button type="submit" class="btn btn-submit btn-grow">ì‘ì—… ë“±ë¡</button>
      </div>
    </div>
  </form>

  <form action="{{ url_for('dashboard') }}" method="get" style="margin-top:16px;">
    <button type="submit" class="btn btn-ghost" style="width:100%;">ğŸ  ë©”ì¸í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
  </form>

  <!-- ë“±ë¡ ì„±ê³µ ëª¨ë‹¬ -->
  <div id="successModal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,.28);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:24px;border-radius:14px;min-width:280px;box-shadow:0 10px 35px rgba(0,0,0,.2);text-align:center;">
      <h3 style="margin:0 0 12px;">ì‘ì—…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
        <button class="btn btn-ghost" id="againBtn" type="button">ì‘ì—…ë“±ë¡ ì´ì–´ì„œí•˜ê¸°</button>
        <a class="btn btn-next" id="viewCreatedBtn"
           href="{{ url_for('view_jobs',
                             date=(registered_filters.date if registered_filters else ''),
                             worker=(registered_filters.worker if registered_filters else '')) }}">
          ë“±ë¡ëœ ì‘ì—… í™•ì¸í•˜ê¸°
        </a>
      </div>
    </div>
  </div>

  <script>
    // ==== ì„œë²„ ë°ì´í„° ====
    const RECENT_LOCS = {{ (locations or [])|tojson|safe }};
    const DRAFT_KEY = 'add_job_wizard_draft';
    let ALLOW_SAVE = true;

    // ìƒë‹¨ 'ì´ˆê¸°í™”' ë²„íŠ¼: ì™„ì „ ì´ˆê¸°í™”
    document.getElementById('resetBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      ALLOW_SAVE = false;
      window.removeEventListener('beforeunload', saveDraft);
      sessionStorage.removeItem(DRAFT_KEY);
      sessionStorage.removeItem(DRAFT_KEY + ':step');
      location.replace("{{ url_for('add_job') }}");
    });

    // ì„±ê³µ ëª¨ë‹¬: ì´ì–´ì„œí•˜ê¸°(ì™„ì „ ì´ˆê¸°í™” í›„ 1ë‹¨ê³„ë¶€í„°)
    (function(){
      const btn = document.getElementById('againBtn');
      if(!btn) return;
      btn.addEventListener('click', function(){
        try{ ALLOW_SAVE = false; }catch(e){}
        try{
          sessionStorage.removeItem('add_job_wizard_draft');
          sessionStorage.removeItem('add_job_wizard_draft:step');
        }catch(e){}
        location.href = "{{ url_for('add_job') }}";
      });
    })();

    // Nì‹œê°„ í‘œì‹œ í† ê¸€
    (function(){
      const typeSel = document.getElementById('duration_type');
      const hoursSel = document.getElementById('duration_hours');
      const sync = ()=> hoursSel.style.display = (typeSel.value === 'Nì‹œê°„') ? '' : 'none';
      typeSel.addEventListener('change', sync); sync();
    })();

    // ì™¸ì£¼ íƒ€ì…ì— ë”°ë¼ ì—…ì²´ëª… ì…ë ¥ ë¹„í™œì„±í™”(+ê°’ ë¹„ìš°ê¸°)
    (function(){
      const radios = document.querySelectorAll('input[name="outsource_type"]');
      const partner = document.querySelector('input[name="outsource_partner"]');
      if(!partner || !radios.length) return;
      function sync(){
        const none = document.querySelector('input[name="outsource_type"][value="none"]').checked;
        partner.disabled = none;
        partner.classList.toggle('readonly-like', none);
        if(none) partner.value = '';
      }
      radios.forEach(r=> r.addEventListener('change', sync));
      sync();
    })();

    // ì„ì°¨ì¸ = ì›ìˆ˜ê¸‰ìì™€ ë™ì¼
    (function(){
      const same = document.getElementById('same_as_owner');
      const ownerIn = document.querySelector('input[name="client_primary"]');
      const tenantIn= document.getElementById('tenant_input');
      if(!same || !ownerIn || !tenantIn) return;
      const lock = (on)=>{
        if(on){ tenantIn.value = ownerIn.value || ''; tenantIn.readOnly = true; tenantIn.classList.add('readonly-like'); }
        else  { tenantIn.readOnly = false; tenantIn.classList.remove('readonly-like'); }
      };
      lock(same.checked);
      same.addEventListener('change', ()=> lock(same.checked));
      ownerIn.addEventListener('input', ()=> { if(same.checked) tenantIn.value = ownerIn.value; });
    })();

    // ìœ„ì¹˜ ìë™ì™„ì„±
    (function(){
      const inp = document.getElementById('location_input');
      const box = document.getElementById('locSug');
      if(!inp || !box) return;
      const uniq = (arr)=>[...new Map(arr.map(v=>[String(v||'').trim(), String(v||'').trim()])).values()];
      const base = uniq(RECENT_LOCS).filter(Boolean).slice(0,20);
      function render(list){
        box.innerHTML = '';
        list.forEach(v=>{
          const d = document.createElement('div'); d.textContent = v;
          d.addEventListener('mousedown', (e)=>{ e.preventDefault(); inp.value = v; hide(); });
          box.appendChild(d);
        });
        box.classList.toggle('show', list.length>0);
      }
      function hide(){ box.classList.remove('show'); }
      function filter(){
        const q = (inp.value||'').trim().toLowerCase();
        if(!q){ render(base); return; }
        render(base.filter(v => v.toLowerCase().includes(q)));
      }
      inp.addEventListener('focus', filter);
      inp.addEventListener('input', filter);
      inp.addEventListener('blur', ()=> setTimeout(hide, 120));
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hide(); });
    })();

    // ===== ìœ„ì €ë“œ & ì´ˆì•ˆ ì €ì¥ =====
    let cur = 1, maxStep = 9;
    const steps = [...document.querySelectorAll('.step')];
    const dots  = [...document.querySelectorAll('#stepsBar .dot')];

    function showStep(n){
      cur = n;
      steps.forEach(s => s.classList.toggle('active', +s.dataset.step===n));
      dots.forEach((d,i)=> d.classList.toggle('on', i < n));
      sessionStorage.setItem(DRAFT_KEY + ':step', String(n));
      window.scrollTo({top:0, behavior:'smooth'});
    }
    window.nextStep = function(){ if(!validate(cur)) return; if(cur < maxStep) showStep(cur+1); }
    window.prevStep = function(){ if(cur > 1) showStep(cur-1); }

    function validate(n){
      if(n===1){ if(!document.getElementById('date').value){ alert('ë‚ ì§œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return false; } }
      if(n===2){
        const h=document.getElementById('hour').value, m=document.getElementById('minute').value;
        if(!h||!m){ alert('ì‹œê°„(ì‹œ/ë¶„)ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return false; }
      }
      if(n===3){ if(!document.getElementById('worker_input').value.trim()){ alert('ê¸°ì‚¬ë¥¼ ì…ë ¥(ë˜ëŠ” ì„ íƒ)í•´ ì£¼ì„¸ìš”.'); return false; } }
      if(n===4){
        const mn=document.getElementById('machine_name_input').value.trim();
        const no=document.getElementById('machine_number_input').value.trim();
        if(!mn||!no){ alert('ì¥ë¹„ëª…ê³¼ ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return false; }
      }
      if(n===5){
        const p=document.querySelector('input[name="client_primary"]').value.trim();
        if(!p){ alert('ë°œì£¼ì(ì›ìˆ˜ê¸‰ì)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return false; }
      }
      if(n===6){ if(!document.getElementById('location_input').value.trim()){ alert('ì‘ì—… ìœ„ì¹˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return false; } }
      return true;
    }

    function saveDraft(){
      if (!ALLOW_SAVE) return;
      const form = document.getElementById('jobForm');
      const data = new FormData(form);
      const obj = {};
      data.forEach((v,k)=>{ if(!(k in obj)) obj[k]=v; });
      sessionStorage.setItem(DRAFT_KEY, JSON.stringify(obj));
      sessionStorage.setItem(DRAFT_KEY + ':step', String(cur));
    }
    function loadDraft(){
      try{
        const raw = sessionStorage.getItem(DRAFT_KEY);
        if(raw){
          const obj = JSON.parse(raw);
          Object.entries(obj).forEach(([k,v])=>{
            const el = document.querySelector('[name="'+CSS.escape(k)+'"]');
            if(!el) return;
            if(el.type==='checkbox' || el.type==='radio'){
              el.checked = (String(el.value)===String(v)) || (v===true || v==='on' || v==='1');
            }else{
              el.value = v;
            }
          });
        }
        const stepRaw = sessionStorage.getItem(DRAFT_KEY + ':step');
        showStep(stepRaw ? (+stepRaw || 1) : 1);
      }catch(e){}
    }
    document.getElementById('jobForm').addEventListener('input', saveDraft);
    window.addEventListener('beforeunload', saveDraft);
    document.querySelectorAll('a[href*="from=add_job"]').forEach(a=>{
      a.addEventListener('click', saveDraft);
    });
    window.addEventListener('load', loadDraft);

    // ì œì¶œ ì‹œ: ì‹œê°„ í•©ì¹˜ê¸°, Nì‹œê°„ ì²˜ë¦¬, ì´ˆì•ˆ ì‚­ì œ
    document.getElementById('jobForm').addEventListener('submit', function(e){
      const ok = validate(1)&&validate(2)&&validate(3)&&validate(4)&&validate(5)&&validate(6);
      if(!ok){ e.preventDefault(); return; }
      const h=document.getElementById('hour').value, m=document.getElementById('minute').value;
      const t=document.createElement('input'); t.type='hidden'; t.name='time'; t.value=h+':'+m; this.appendChild(t);
      if(document.getElementById('duration_type').value !== 'Nì‹œê°„'){
        const dh=document.getElementById('duration_hours'); if(dh) dh.disabled = true;
      }
      sessionStorage.removeItem(DRAFT_KEY);
      sessionStorage.removeItem(DRAFT_KEY + ':step');
    });

    // ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ
    {% if job_registered %} document.getElementById('successModal').style.display = 'flex'; {% endif %}
  </script>
</body>
</html>
