<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>전체 작업 목록</title>
  <style>
    :root{
      --gap:12px; --radius:10px; --border:#e5e7eb; --bg:#f7f7f9; --muted:#6b7280;
      --blue:#1e90ff; --green:#22c55e; --red:#ef4444;
    }
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'맑은 고딕',sans-serif;
      max-width:clamp(980px, 92vw, 1280px);
      margin:36px auto; padding:0 16px; background:#fafafa;
    }
    h2{font-size:26px; font-weight:800; text-align:center; margin:0 0 18px;}

    .btn{display:inline-flex; align-items:center; gap:6px; border:none; border-radius:8px; padding:10px 14px; font-size:14px; cursor:pointer; text-decoration:none;}
    .btn-blue{background:var(--blue); color:#fff;}
    .btn-ghost{background:#eef2f7; color:#334155;}
    .btn-green{background:var(--green); color:#fff;}
    .btn-red{background:var(--red); color:#fff;}
    a.btn.chip{ background:#9ca3af; color:#fff; }
    a.btn.chip.on{ background:#f59e0b; color:#fff; }

    /* ── 상단 검색: 가로 한 줄 ── */
    .filters-row{
      display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap;
      margin:8px 0 12px;
    }
    .filters-row input[type="text"],
    .filters-row input[type="date"]{
      height:36px; padding:0 12px; border:1px solid var(--border); border-radius:8px;
      background:#fff; min-width:200px; font-size:14px;
    }
    .filters-row .btn{ height:36px; padding:0 14px; }

    /* 토글 버튼 줄 */
    .calendar-wrap{ display:flex; justify-content:center; gap:10px; margin:10px 0 16px; }

    /* 표/상세 */
    .bulk{display:flex; gap:10px; align-items:center; margin: 6px 0 14px; flex-wrap:wrap;}
    .hint{color:var(--muted); font-size:13px;}
    .table-wrap{background:#fff; border-radius:var(--radius); border:1px solid var(--border); overflow-x:auto;}
    table{width:100%; border-collapse:collapse; table-layout:fixed; min-width:960px;}
    th,td{padding:clamp(8px, 1.2vw, 14px) 10px; text-align:center; border-bottom:1px solid var(--border);}
    th{background:#f3f4f6; font-weight:700;}
    tr:hover td{background:#fbfcff;}
    .arrow{padding:8px 10px; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer;}
    .status{font-weight:700;}
    .done{color:#16a34a;} .todo{color:#334155;}

    .detail-row{display:none;}
    .detail{background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:14px; margin:8px; display:grid; grid-template-columns:1fr 1fr; gap:10px 18px; text-align:left;}
    .detail-actions{grid-column:1 / -1; display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;}

    /* 기사/칩 */
    .worker-name{display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .spare-badge{display:inline-block; margin-top:4px; padding:1px 6px; border-radius:8px; background:#e8f1ff; color:#1d4ed8; font-size:12px; font-weight:600;}
    .price-chip,.badge-partial,.badge-unpaid{display:inline-block; margin-left:6px; padding:2px 6px; border-radius:8px; font-size:12px; vertical-align:middle;}
    .price-missing{display:inline-block; margin-left:6px; padding:2px 6px; border-radius:8px; background:#fff1f2; color:#b91c1c; font-size:12px; vertical-align:middle;}
    .badge-partial{ background:#fff7ed; color:#c2410c; }
    .badge-unpaid { background:#fee2e2; color:#b91c1c; }
    .tag-blue{display:inline-block; padding:2px 6px; border-radius:8px; background:#e6f0ff; color:#1d4ed8; font-size:12px; margin-left:6px;}
    .tag-purple{display:inline-block; padding:2px 6px; border-radius:8px; background:#ede9fe; color:#6d28d9; font-size:12px; margin-left:6px;}
    .ellipsis{display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .copy-link{font-size:12px; text-decoration:underline; cursor:pointer; color:#2563eb;}

    .pay-chips{display:flex; gap:6px; flex-wrap:wrap; justify-content:center;}
    .pay-actions{margin-top:6px; display:flex; gap:6px; justify-content:center; flex-wrap:wrap;}

    @media (max-width:1200px){
      .btn{padding:8px 12px; font-size:13px;}
      .price-chip,.price-missing,.tag-blue,.badge-partial,.badge-unpaid{font-size:11px; padding:1px 5px;}
    }
    @media (max-width:980px){
      .detail{grid-template-columns:1fr;}
    }
  </style>
</head>
<script>
"use strict";

(function(){
  /* ===== 선택 상태 localStorage 보관 ===== */
  function _key(){ return "jobs_selected_indices"; }
  function getSel(){
    try { return JSON.parse(localStorage.getItem(_key()) || "[]"); }
    catch { return []; }
  }
  function setSel(list){
    const norm = Array.from(new Set(list.map(v => parseInt(v,10)).filter(n => !isNaN(n))));
    localStorage.setItem(_key(), JSON.stringify(norm));
  }
  function syncCheckboxesFromStorage(){
    const selSet = new Set(getSel().map(String));

    // 개별 체크박스 동기화 + 변경 시 저장
    document.querySelectorAll('input[name="selected_jobs"]').forEach(cb => {
      cb.checked = selSet.has(cb.value);
      cb.addEventListener("change", () => {
        const cur = new Set(getSel());
        const v = parseInt(cb.value,10);
        if (cb.checked) cur.add(v); else cur.delete(v);
        setSel([...cur]);
      });
    });

    // 전체 선택
    const all = document.getElementById("selectAll");
    if (all){
      all.addEventListener("change", () => {
        const want = all.checked;
        const cur = new Set(getSel());
        document.querySelectorAll('input[name="selected_jobs"]').forEach(cb => {
          cb.checked = want;
          const v = parseInt(cb.value,10);
          if (want) cur.add(v); else cur.delete(v);
        });
        setSel([...cur]);
      });
    }
  }
  document.addEventListener("DOMContentLoaded", syncCheckboxesFromStorage);
  window.addEventListener("pageshow",   syncCheckboxesFromStorage);

  /* ===== 선택값을 폼에 숨은필드로 붙이기 ===== */
  function attachHiddenSelected(form){
    form.querySelectorAll('input[type="hidden"][name="selected_jobs"]').forEach(el => el.remove());
    getSel().forEach(v => {
      const i = document.createElement("input");
      i.type = "hidden"; i.name = "selected_jobs"; i.value = String(v);
      form.appendChild(i);
    });
  }

  /* ===== 일괄 처리(완료/삭제) ===== */
  window.setBulk = function(action){
    if (action === "delete" && !confirm("선택한 작업을 삭제하시겠습니까?")) return;
    document.getElementById("bulkAction").value = action;
    const form = document.getElementById("bulkForm");
    attachHiddenSelected(form);
    form.submit();
  };

  /* ===== 선택 엑셀 받기 ===== */
  window.exportSelected = function(){
    const selected = getSel();
    if (!selected.length){ alert("선택된 작업이 없습니다."); return; }

    const form = document.createElement("form");
    form.method = "POST";
    form.action = "{{ url_for('export_selected_xlsx') }}";  // 서버 라우트 이름
    form.style.display = "none";
    document.body.appendChild(form);

    attachHiddenSelected(form);
    form.submit();
    setTimeout(() => form.remove(), 1000);
  };

  /* ===== 상세보기(화살표) 토글 ===== */
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".arrow");
    if (!btn) return;
    const id = btn.dataset.target;
    const row = document.getElementById(id);
    if (!row) return;
    const open = row.style.display === "table-row";
    row.style.display = open ? "none" : "table-row";
    btn.textContent = open ? "▼" : "▲";
  });

  /* ===== 결제/상태 토글 ===== */
  function setPStatusBadge(el, status){
    if(!el) return;
    el.classList.remove("price-chip","price-missing","badge-partial","badge-unpaid");
    if(status === "부분") el.classList.add("badge-partial");
    else if(status === "미납") el.classList.add("badge-unpaid");
    else if(status === "미설정") el.classList.add("price-missing");
    else el.classList.add("price-chip");
  }

  function applyPaymentUI(idx, data){
    const pstatusEl = document.getElementById("pstatus-"+idx);
    const remainEl  = document.getElementById("remain-"+idx);
    if(pstatusEl){ pstatusEl.textContent = data.payment_status || ""; setPStatusBadge(pstatusEl, data.payment_status || ""); }
    if(remainEl){  remainEl.textContent  = "잔액 " + ((data.remaining ?? 0)) + "만"; }

    const cell = document.getElementById("paycell-"+idx);
    if(!cell) return;
    const btns = cell.querySelectorAll("button");
    btns.forEach(b=>{
      if(b.textContent.includes("부분")) return; // 부분완납 버튼은 그대로
      if(data.payment_status === "완납"){
        b.classList.remove("btn-green"); b.classList.add("btn-red");
        b.textContent = "완납취소";
        b.setAttribute("onclick","toggleFullPaid(this,false)");
      }else{
        b.classList.remove("btn-red"); b.classList.add("btn-green");
        b.textContent = "완납";
        b.setAttribute("onclick","toggleFullPaid(this,true)");
      }
    });
  }

  window.toggleStatus = async function(btn){
    const idx = btn.dataset.index;
    const url = btn.dataset.url;
    try{
      const res = await fetch(url, { method:"POST", headers:{ "X-Requested-With":"XMLHttpRequest", "Accept":"application/json" }, credentials:"same-origin" });
      if (res.redirected){ alert("로그인이 필요합니다."); location.href = res.url; return; }
      const data = await res.json();
      if (!res.ok || !data?.success){ alert("변경 실패: " + (data?.error || res.status)); return; }

      const cell = document.getElementById("status-"+idx);
      if(cell){
        cell.textContent = data.status || "";
        cell.classList.toggle("done", data.status === "완료");
        cell.classList.toggle("todo", data.status !== "완료");
      }
      document.querySelectorAll(`button.status-toggle[data-index="${idx}"]`).forEach(b=>{
        b.textContent = (data.status === "완료") ? "완료취소" : "완료";
      });
    }catch(err){ console.error(err); alert("네트워크 오류"); }
  };

  window.toggleFullPaid = async function(btn, makeFull){
    const idx = btn.dataset.index;
    const url = btn.dataset.url;
    try{
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Accept":"application/json" },
        credentials:"same-origin",
        body: JSON.stringify({ action: makeFull ? "full" : "unpay" })
      });
      if (res.redirected){ alert("로그인이 필요합니다."); location.href = res.url; return; }
      const data = await res.json();
      if (!res.ok || !data?.success){ alert("지불 상태 변경 실패: " + (data?.error || res.status)); return; }
      applyPaymentUI(idx, data);
    }catch(e){ console.error(e); alert("네트워크 오류"); }
  };

  window.partialPaid = async function(btn){
    const idx = btn.dataset.index;
    const url = btn.dataset.url;
    const val = prompt("부분 완납 금액(만원) 입력");
    if (val === null) return;
    const n = parseInt(val, 10);
    if (isNaN(n) || n < 0){ alert("숫자를 입력해 주세요."); return; }
    try{
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Accept":"application/json" },
        credentials:"same-origin",
        body: JSON.stringify({ action:"partial", amount_man:n })
      });
      if (res.redirected){ alert("로그인이 필요합니다."); location.href = res.url; return; }
      const data = await res.json();
      if (!res.ok || !data?.success){ alert("부분완납 실패: " + (data?.error || res.status)); return; }
      applyPaymentUI(idx, data);
    }catch(e){ console.error(e); alert("네트워크 오류"); }
  };

})();
</script>
<body data-company="{{ session.get('company','') }}">
  <h2>전체 작업 목록</h2>

  <!-- 검색/필터: 가로 한 줄 -->
  <form method="get" class="filters-row">
    <input type="text" name="worker" placeholder="기사명"
           value="{{ request.args.get('worker','') }}" aria-label="기사명">

    <input list="owners_datalist" type="text" name="owner" placeholder="원수급자"
           value="{{ q_owner or request.args.get('owner','') }}" aria-label="원수급자">
    <datalist id="owners_datalist">
      {% for o in owners %}<option value="{{ o }}"></option>{% endfor %}
    </datalist>

    <input list="tenants_datalist" type="text" name="tenant" placeholder="임차인"
           value="{{ q_tenant or request.args.get('tenant','') }}" aria-label="임차인">
    <datalist id="tenants_datalist">
      {% for t in tenants %}<option value="{{ t }}"></option>{% endfor %}
    </datalist>

    <!-- 날짜 범위 -->
<input type="date" name="date_from" value="{{ request.args.get('date_from','') }}" aria-label="시작일">
<span>~</span>
<input type="date" name="date_to"   value="{{ request.args.get('date_to','') }}"   aria-label="종료일">


    {% if spare  == '1' %}<input type="hidden" name="spare"  value="1">{% endif %}
    {% if outsrc == '1' %}<input type="hidden" name="outsrc" value="1">{% endif %}
    {% if overdue== '1' %}<input type="hidden" name="overdue" value="1">{% endif %}
    {% if dues   == '1' %}<input type="hidden" name="dues"    value="1">{% endif %}

    <button type="submit" class="btn btn-blue">검색</button>
    <a href="{{ url_for('view_jobs') }}" class="btn btn-ghost">초기화</a>
  </form>

  <!-- 캘린더 & 토글 버튼 -->
  <div class="calendar-wrap">
    <a href="{{ url_for('calendar_view') }}" class="btn btn-green">📅 캘린더 보기</a>

    {% if overdue == '1' %}
      <a href="{{ overdue_off_url }}" class="btn btn-blue">이전으로</a>
    {% else %}
      <a href="{{ overdue_on_url }}" class="btn btn-blue">진행중인 작업만</a>
    {% endif %}

    {% if dues == '1' %}
      <a href="{{ dues_off_url }}" class="btn btn-red">이전으로</a>
    {% else %}
      <a href="{{ dues_on_url }}" class="btn btn-red">미납된 작업보기</a>
    {% endif %}

    {% if spare == '1' %}
      <a href="{{ spare_off_url }}" class="btn chip on">이전으로</a>
    {% else %}
      <a href="{{ spare_on_url }}" class="btn chip">스페어만</a>
    {% endif %}

    {% if outsrc == '1' %}
      <a href="{{ outsrc_off_url }}" class="btn chip on">이전으로</a>
    {% else %}
      <a href="{{ outsrc_on_url }}" class="btn chip">외주작업만</a>
    {% endif %}
  </div>

  <!-- 일괄 처리 -->
  <form id="bulkForm" method="post" action="{{ url_for('bulk_action') }}">
    <input type="hidden" name="action" id="bulkAction" value="">
    <div class="bulk">
      <button type="button" class="btn btn-green" onclick="setBulk('complete')">선택 완료</button>
      <button type="button" class="btn btn-red"   onclick="setBulk('delete')">선택 삭제</button>
      <button type="button" class="btn btn-ghost" onclick="exportSelected()">선택 엑셀받기</button>
      <button type="button" class="btn btn-ghost" onclick="clearSelection()">선택 해제</button>
      <span class="hint">체크한 항목에만 적용됩니다. (검색/필터 변경 시에도 선택 유지)</span>
    </div>

    <div class="table-wrap">
      {% if jobs and jobs|length>0 %}
      <table>
        <colgroup>
          <col style="width:4%;">
          <col style="width:11%;">
          <col style="width:12%;">
          <col style="width:21%;">
          <col style="width:22%;">
          <col style="width:18%;">
          <col style="width:12%;">
        </colgroup>
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>날짜</th>
            <th>기사</th>
            <th>장비(명/차량번호)</th>
            <th>거래처 / 금액</th>
            <th>지불 상태</th>
            <th>관리</th>
          </tr>
        </thead>
        <tbody>
          {% for job in jobs %}
          {% set mname = job.machine_name or job.machine %}
          {% set mnum  = job.machine_number %}
          {% set malias = job.machine_alias %}
          {% set myear  = job.machine_year %}
          {% set amt = (job.amount_man if job.amount_man is defined else 0) | int %}
          <tr>
            <td><input type="checkbox" name="selected_jobs" value="{{ job._idx }}"></td>
            <td>{{ job.date }}</td>

            <td>
              {% set w = job.worker or '-' %}
              <span class="worker-name" title="{{ w }}">{{ w }}</span>
              {% if job.is_spare %}<span class="spare-badge">(스페어)</span>{% endif %}
            </td>

            <td>
              <span class="ellipsis" title="{{ (mname or '-') ~ ((' / ' ~ mnum) if mnum else '') }}">
                {{ mname or '-' }}{% if mnum %} / {{ mnum }}{% endif %}
              </span>
            </td>

            <td>
              {% set owner  = job.client_primary or job.client or '-' %}
              {% set tenant = job.client_tenant or '' %}

              {% if tenant and tenant != owner %}
                <span class="ellipsis" title="{{ owner }} / {{ tenant }}">{{ owner }} / {{ tenant }}</span>
              {% else %}
                <span class="ellipsis" title="{{ owner }}">{{ owner }}</span>
              {% endif %}

              {% if amt > 0 %}
                <span class="price-chip" title="{{ amt }}만">₩{{ amt }}만</span>
              {% else %}
                <span class="price-missing">금액설정 X</span>
              {% endif %}

              {% set ot = job.outsource_type or 'none' %}
              {% if ot != 'none' %}
                {% set tagclass = 'tag-blue' if ot=='received' else 'tag-purple' %}
                <span class="{{ tagclass }}" title="{{ job.outsource_partner }} ({{ '받음' if ot=='received' else '줬음' }})">외주</span>
              {% endif %}
            </td>

            <td id="paycell-{{ job._idx }}">
              {% set amount = (job.amount_man if job.amount_man is defined else 0) | int %}
              {% set paid   = (job.paid_amount_man if job.paid_amount_man is defined else 0) | int %}
              {% set remaining = amount - paid %}
              {% set pstatus = job.payment_status
                                or ('미설정' if amount <= 0
                                    else ('완납' if paid >= amount
                                          else ('미납' if paid <= 0 else '부분'))) %}
              <div class="pay-chips">
                {% if amount > 0 %}
                  <span class="price-chip">총 ₩{{ amount }}만</span>
                  <span class="price-chip" id="remain-{{ job._idx }}">잔액 {{ remaining if remaining>0 else 0 }}만</span>

                  {% set pclass = 'price-chip' %}
                  {% if pstatus == '부분' %}{% set pclass = 'badge-partial' %}
                  {% elif pstatus == '미납' %}{% set pclass = 'badge-unpaid' %}
                  {% elif pstatus == '미설정' %}{% set pclass = 'price-missing' %}{% endif %}
                  <span class="{{ pclass }}" id="pstatus-{{ job._idx }}">{{ pstatus }}</span>
                {% else %}
                  <span class="price-missing" id="pstatus-{{ job._idx }}">금액 미설정</span>
                {% endif %}
              </div>

              {% if amount > 0 %}
              <div class="pay-actions">
                {% if pstatus == '완납' %}
                  <button type="button" class="btn btn-red"
                          data-index="{{ job._idx }}"
                          data-url="{{ url_for('payment_api', job_index=job._idx) }}"
                          onclick="toggleFullPaid(this, false)">완납취소</button>
                {% else %}
                  <button type="button" class="btn btn-green"
                          data-index="{{ job._idx }}"
                          data-url="{{ url_for('payment_api', job_index=job._idx) }}"
                          onclick="toggleFullPaid(this, true)">완납</button>
                {% endif %}
                <button type="button" class="btn btn-ghost"
                        data-index="{{ job._idx }}"
                        data-url="{{ url_for('payment_api', job_index=job._idx) }}"
                        onclick="partialPaid(this)">부분완납</button>
              </div>
              {% endif %}
            </td>

            <td style="display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap;">
              <span id="status-{{ job._idx }}" class="status {{ 'done' if job.status=='완료' else 'todo' }}">
                {{ job.status or '진행중' }}
              </span>

              <button type="button" class="arrow" data-target="d-{{ loop.index0 }}">▼</button>

              <button type="button" class="btn btn-ghost status-toggle"
                      data-index="{{ job._idx }}"
                      data-url="{{ url_for('toggle_complete_api', job_index=job._idx) }}"
                      onclick="toggleStatus(this)">
                {% if job.status=='완료' %}완료취소{% else %}완료{% endif %}
              </button>
            </td>
          </tr>

          <tr id="d-{{ loop.index0 }}" class="detail-row">
            <td colspan="7">
              <div class="detail">
                <div>
                  <b>장비:</b>
                  {{ mname or '-' }}{% if mnum %} / {{ mnum }}{% endif %}
                  {% if malias %} / <span style="color:#6b7280;">{{ malias }}</span>{% endif %}
                  {% if myear  %} / <span style="color:#6b7280;">{{ myear }}</span>{% endif %}
                </div>
                <div>
                  <b>위치:</b>
                  {{ job.location or '-' }}
                  {% if job.location %}
                    <span class="copy-link" onclick="copyToClipboard(`{{ (job.location or '')|replace('`','\\`') }}`)">복사</span>
                  {% endif %}
                </div>
                <div style="grid-column:1 / -1;"><b>요청사항:</b> {{ job.note or '-' }}</div>
                <div><b>발주/임차:</b> {{ owner }}{% if tenant %} / {{ tenant }}{% endif %}</div>
                <div><b>외주내역:</b>
                  {% set ot = job.outsource_type or 'none' %}
                  {% if ot != 'none' %}
                    {{ job.outsource_partner or '-' }} ({{ '받음' if ot=='received' else '줬음' }})
                  {% else %}-{% endif %}
                </div>
                <div class="detail-actions">
                  <a href="{{ url_for('edit_job', job_index=job._idx) }}" class="btn btn-blue">수정</a>
                  <a href="{{ url_for('delete_job', job_index=job._idx) }}" class="btn btn-red" onclick="return confirm('삭제하시겠습니까?');">삭제</a>
                  <button type="button" class="btn btn-green status-toggle"
                          data-index="{{ job._idx }}"
                          data-url="{{ url_for('toggle_complete_api', job_index=job._idx) }}"
                          onclick="toggleStatus(this)">
                    {% if job.status=='완료' %}완료취소{% else %}완료{% endif %}
                  </button>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div style="padding:24px; text-align:center;">등록된 작업이 없습니다.</div>
      {% endif %}
    </div>
  </form>

  <div style="display:flex; justify-content:center; margin:18px 0;">
    <form action="{{ url_for('dashboard') }}">
        <button type="submit" style="font-size: 16px;">🏠 메인화면으로 돌아가기</button>
    </form>
  </div>
</body>
</html>
