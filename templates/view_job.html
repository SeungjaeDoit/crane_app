<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì „ì²´ ì‘ì—… ëª©ë¡</title>
  <style>
    :root{
      --gap:12px; --radius:10px; --border:#e5e7eb; --bg:#f7f7f9; --muted:#6b7280;
      --blue:#1e90ff; --green:#22c55e; --red:#ef4444;
    }
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'ë§‘ì€ ê³ ë”•',sans-serif;
      max-width:clamp(980px, 92vw, 1280px);
      margin:36px auto; padding:0 16px; background:#fafafa;
    }
    h2{font-size:26px; font-weight:800; text-align:center; margin:0 0 18px;}

    .btn{display:inline-flex; align-items:center; gap:6px; border:none; border-radius:8px; padding:10px 14px; font-size:14px; cursor:pointer; text-decoration:none;}
    .btn-blue{background:var(--blue); color:#fff;}
    .btn-ghost{background:#eef2f7; color:#334155;}
    .btn-green{background:var(--green); color:#fff;}
    .btn-red{background:var(--red); color:#fff;}
    a.btn.chip{ background:#9ca3af; color:#fff; }
    a.btn.chip.on{ background:#f59e0b; color:#fff; }

    /* â”€â”€ ìƒë‹¨ ê²€ìƒ‰: ê°€ë¡œ í•œ ì¤„ â”€â”€ */
    .filters-row{
      display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap;
      margin:8px 0 12px;
    }
    .filters-row input[type="text"],
    .filters-row input[type="date"]{
      height:36px; padding:0 12px; border:1px solid var(--border); border-radius:8px;
      background:#fff; min-width:200px; font-size:14px;
    }
    .filters-row .btn{ height:36px; padding:0 14px; }

    /* í† ê¸€ ë²„íŠ¼ ì¤„ */
    .calendar-wrap{ display:flex; justify-content:center; gap:10px; margin:10px 0 16px; }

    /* í‘œ/ìƒì„¸ */
    .bulk{display:flex; gap:10px; align-items:center; margin: 6px 0 14px; flex-wrap:wrap;}
    .hint{color:var(--muted); font-size:13px;}
    .table-wrap{background:#fff; border-radius:var(--radius); border:1px solid var(--border); overflow-x:auto;}
    table{width:100%; border-collapse:collapse; table-layout:fixed; min-width:960px;}
    th,td{padding:clamp(8px, 1.2vw, 14px) 10px; text-align:center; border-bottom:1px solid var(--border);}
    th{background:#f3f4f6; font-weight:700;}
    tr:hover td{background:#fbfcff;}
    .arrow{padding:8px 10px; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer;}
    .status{font-weight:700;}
    .done{color:#16a34a;} .todo{color:#334155;}

    .detail-row{display:none;}
    .detail{background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:14px; margin:8px; display:grid; grid-template-columns:1fr 1fr; gap:10px 18px; text-align:left;}
    .detail-actions{grid-column:1 / -1; display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;}

    /* ê¸°ì‚¬/ì¹© */
    .worker-name{display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .spare-badge{display:inline-block; margin-top:4px; padding:1px 6px; border-radius:8px; background:#e8f1ff; color:#1d4ed8; font-size:12px; font-weight:600;}
    .price-chip,.badge-partial,.badge-unpaid{display:inline-block; margin-left:6px; padding:2px 6px; border-radius:8px; font-size:12px; vertical-align:middle;}
    .price-missing{display:inline-block; margin-left:6px; padding:2px 6px; border-radius:8px; background:#fff1f2; color:#b91c1c; font-size:12px; vertical-align:middle;}
    .badge-partial{ background:#fff7ed; color:#c2410c; }
    .badge-unpaid { background:#fee2e2; color:#b91c1c; }
    .tag-blue{display:inline-block; padding:2px 6px; border-radius:8px; background:#e6f0ff; color:#1d4ed8; font-size:12px; margin-left:6px;}
    .tag-purple{display:inline-block; padding:2px 6px; border-radius:8px; background:#ede9fe; color:#6d28d9; font-size:12px; margin-left:6px;}
    .ellipsis{display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .copy-link{font-size:12px; text-decoration:underline; cursor:pointer; color:#2563eb;}

    .pay-chips{display:flex; gap:6px; flex-wrap:wrap; justify-content:center;}
    .pay-actions{margin-top:6px; display:flex; gap:6px; justify-content:center; flex-wrap:wrap;}

    @media (max-width:1200px){
      .btn{padding:8px 12px; font-size:13px;}
      .price-chip,.price-missing,.tag-blue,.badge-partial,.badge-unpaid{font-size:11px; padding:1px 5px;}
    }
    @media (max-width:980px){
      .detail{grid-template-columns:1fr;}
    }
  </style>
</head>
<script>
"use strict";

(function(){
  /* ===== ì„ íƒ ìƒíƒœ localStorage ë³´ê´€ ===== */
  function _key(){ return "jobs_selected_indices"; }
  function getSel(){
    try { return JSON.parse(localStorage.getItem(_key()) || "[]"); }
    catch { return []; }
  }
  function setSel(list){
    const norm = Array.from(new Set(list.map(v => parseInt(v,10)).filter(n => !isNaN(n))));
    localStorage.setItem(_key(), JSON.stringify(norm));
  }
  function syncCheckboxesFromStorage(){
    const selSet = new Set(getSel().map(String));

    // ê°œë³„ ì²´í¬ë°•ìŠ¤ ë™ê¸°í™” + ë³€ê²½ ì‹œ ì €ì¥
    document.querySelectorAll('input[name="selected_jobs"]').forEach(cb => {
      cb.checked = selSet.has(cb.value);
      cb.addEventListener("change", () => {
        const cur = new Set(getSel());
        const v = parseInt(cb.value,10);
        if (cb.checked) cur.add(v); else cur.delete(v);
        setSel([...cur]);
      });
    });

    // ì „ì²´ ì„ íƒ
    const all = document.getElementById("selectAll");
    if (all){
      all.addEventListener("change", () => {
        const want = all.checked;
        const cur = new Set(getSel());
        document.querySelectorAll('input[name="selected_jobs"]').forEach(cb => {
          cb.checked = want;
          const v = parseInt(cb.value,10);
          if (want) cur.add(v); else cur.delete(v);
        });
        setSel([...cur]);
      });
    }
  }
  document.addEventListener("DOMContentLoaded", syncCheckboxesFromStorage);
  window.addEventListener("pageshow",   syncCheckboxesFromStorage);

  /* ===== ì„ íƒê°’ì„ í¼ì— ìˆ¨ì€í•„ë“œë¡œ ë¶™ì´ê¸° ===== */
  function attachHiddenSelected(form){
    form.querySelectorAll('input[type="hidden"][name="selected_jobs"]').forEach(el => el.remove());
    getSel().forEach(v => {
      const i = document.createElement("input");
      i.type = "hidden"; i.name = "selected_jobs"; i.value = String(v);
      form.appendChild(i);
    });
  }

  /* ===== ì¼ê´„ ì²˜ë¦¬(ì™„ë£Œ/ì‚­ì œ) ===== */
  window.setBulk = function(action){
    if (action === "delete" && !confirm("ì„ íƒí•œ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    document.getElementById("bulkAction").value = action;
    const form = document.getElementById("bulkForm");
    attachHiddenSelected(form);
    form.submit();
  };

  /* ===== ì„ íƒ ì—‘ì…€ ë°›ê¸° ===== */
  window.exportSelected = function(){
    const selected = getSel();
    if (!selected.length){ alert("ì„ íƒëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤."); return; }

    const form = document.createElement("form");
    form.method = "POST";
    form.action = "{{ url_for('export_selected_xlsx') }}";  // ì„œë²„ ë¼ìš°íŠ¸ ì´ë¦„
    form.style.display = "none";
    document.body.appendChild(form);

    attachHiddenSelected(form);
    form.submit();
    setTimeout(() => form.remove(), 1000);
  };

  /* ===== ìƒì„¸ë³´ê¸°(í™”ì‚´í‘œ) í† ê¸€ ===== */
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".arrow");
    if (!btn) return;
    const id = btn.dataset.target;
    const row = document.getElementById(id);
    if (!row) return;
    const open = row.style.display === "table-row";
    row.style.display = open ? "none" : "table-row";
    btn.textContent = open ? "â–¼" : "â–²";
  });

  /* ===== ê²°ì œ/ìƒíƒœ í† ê¸€ ===== */
  function setPStatusBadge(el, status){
    if(!el) return;
    el.classList.remove("price-chip","price-missing","badge-partial","badge-unpaid");
    if(status === "ë¶€ë¶„") el.classList.add("badge-partial");
    else if(status === "ë¯¸ë‚©") el.classList.add("badge-unpaid");
    else if(status === "ë¯¸ì„¤ì •") el.classList.add("price-missing");
    else el.classList.add("price-chip");
  }

  function applyPaymentUI(idx, data){
    const pstatusEl = document.getElementById("pstatus-"+idx);
    const remainEl  = document.getElementById("remain-"+idx);
    if(pstatusEl){ pstatusEl.textContent = data.payment_status || ""; setPStatusBadge(pstatusEl, data.payment_status || ""); }
    if(remainEl){  remainEl.textContent  = "ì”ì•¡ " + ((data.remaining ?? 0)) + "ë§Œ"; }

    const cell = document.getElementById("paycell-"+idx);
    if(!cell) return;
    const btns = cell.querySelectorAll("button");
    btns.forEach(b=>{
      if(b.textContent.includes("ë¶€ë¶„")) return; // ë¶€ë¶„ì™„ë‚© ë²„íŠ¼ì€ ê·¸ëŒ€ë¡œ
      if(data.payment_status === "ì™„ë‚©"){
        b.classList.remove("btn-green"); b.classList.add("btn-red");
        b.textContent = "ì™„ë‚©ì·¨ì†Œ";
        b.setAttribute("onclick","toggleFullPaid(this,false)");
      }else{
        b.classList.remove("btn-red"); b.classList.add("btn-green");
        b.textContent = "ì™„ë‚©";
        b.setAttribute("onclick","toggleFullPaid(this,true)");
      }
    });
  }

  window.toggleStatus = async function(btn){
    const idx = btn.dataset.index;
    const url = btn.dataset.url;
    try{
      const res = await fetch(url, { method:"POST", headers:{ "X-Requested-With":"XMLHttpRequest", "Accept":"application/json" }, credentials:"same-origin" });
      if (res.redirected){ alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href = res.url; return; }
      const data = await res.json();
      if (!res.ok || !data?.success){ alert("ë³€ê²½ ì‹¤íŒ¨: " + (data?.error || res.status)); return; }

      const cell = document.getElementById("status-"+idx);
      if(cell){
        cell.textContent = data.status || "";
        cell.classList.toggle("done", data.status === "ì™„ë£Œ");
        cell.classList.toggle("todo", data.status !== "ì™„ë£Œ");
      }
      document.querySelectorAll(`button.status-toggle[data-index="${idx}"]`).forEach(b=>{
        b.textContent = (data.status === "ì™„ë£Œ") ? "ì™„ë£Œì·¨ì†Œ" : "ì™„ë£Œ";
      });
    }catch(err){ console.error(err); alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜"); }
  };

  window.toggleFullPaid = async function(btn, makeFull){
    const idx = btn.dataset.index;
    const url = btn.dataset.url;
    try{
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Accept":"application/json" },
        credentials:"same-origin",
        body: JSON.stringify({ action: makeFull ? "full" : "unpay" })
      });
      if (res.redirected){ alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href = res.url; return; }
      const data = await res.json();
      if (!res.ok || !data?.success){ alert("ì§€ë¶ˆ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: " + (data?.error || res.status)); return; }
      applyPaymentUI(idx, data);
    }catch(e){ console.error(e); alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜"); }
  };

  window.partialPaid = async function(btn){
    const idx = btn.dataset.index;
    const url = btn.dataset.url;
    const val = prompt("ë¶€ë¶„ ì™„ë‚© ê¸ˆì•¡(ë§Œì›) ì…ë ¥");
    if (val === null) return;
    const n = parseInt(val, 10);
    if (isNaN(n) || n < 0){ alert("ìˆ«ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
    try{
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Accept":"application/json" },
        credentials:"same-origin",
        body: JSON.stringify({ action:"partial", amount_man:n })
      });
      if (res.redirected){ alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href = res.url; return; }
      const data = await res.json();
      if (!res.ok || !data?.success){ alert("ë¶€ë¶„ì™„ë‚© ì‹¤íŒ¨: " + (data?.error || res.status)); return; }
      applyPaymentUI(idx, data);
    }catch(e){ console.error(e); alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜"); }
  };

})();
</script>
<body data-company="{{ session.get('company','') }}">
  <h2>ì „ì²´ ì‘ì—… ëª©ë¡</h2>

  <!-- ê²€ìƒ‰/í•„í„°: ê°€ë¡œ í•œ ì¤„ -->
  <form method="get" class="filters-row">
    <input type="text" name="worker" placeholder="ê¸°ì‚¬ëª…"
           value="{{ request.args.get('worker','') }}" aria-label="ê¸°ì‚¬ëª…">

    <input list="owners_datalist" type="text" name="owner" placeholder="ì›ìˆ˜ê¸‰ì"
           value="{{ q_owner or request.args.get('owner','') }}" aria-label="ì›ìˆ˜ê¸‰ì">
    <datalist id="owners_datalist">
      {% for o in owners %}<option value="{{ o }}"></option>{% endfor %}
    </datalist>

    <input list="tenants_datalist" type="text" name="tenant" placeholder="ì„ì°¨ì¸"
           value="{{ q_tenant or request.args.get('tenant','') }}" aria-label="ì„ì°¨ì¸">
    <datalist id="tenants_datalist">
      {% for t in tenants %}<option value="{{ t }}"></option>{% endfor %}
    </datalist>

    <!-- ë‚ ì§œ ë²”ìœ„ -->
<input type="date" name="date_from" value="{{ request.args.get('date_from','') }}" aria-label="ì‹œì‘ì¼">
<span>~</span>
<input type="date" name="date_to"   value="{{ request.args.get('date_to','') }}"   aria-label="ì¢…ë£Œì¼">


    {% if spare  == '1' %}<input type="hidden" name="spare"  value="1">{% endif %}
    {% if outsrc == '1' %}<input type="hidden" name="outsrc" value="1">{% endif %}
    {% if overdue== '1' %}<input type="hidden" name="overdue" value="1">{% endif %}
    {% if dues   == '1' %}<input type="hidden" name="dues"    value="1">{% endif %}

    <button type="submit" class="btn btn-blue">ê²€ìƒ‰</button>
    <a href="{{ url_for('view_jobs') }}" class="btn btn-ghost">ì´ˆê¸°í™”</a>
  </form>

  <!-- ìº˜ë¦°ë” & í† ê¸€ ë²„íŠ¼ -->
  <div class="calendar-wrap">
    <a href="{{ url_for('calendar_view') }}" class="btn btn-green">ğŸ“… ìº˜ë¦°ë” ë³´ê¸°</a>

    {% if overdue == '1' %}
      <a href="{{ overdue_off_url }}" class="btn btn-blue">ì´ì „ìœ¼ë¡œ</a>
    {% else %}
      <a href="{{ overdue_on_url }}" class="btn btn-blue">ì§„í–‰ì¤‘ì¸ ì‘ì—…ë§Œ</a>
    {% endif %}

    {% if dues == '1' %}
      <a href="{{ dues_off_url }}" class="btn btn-red">ì´ì „ìœ¼ë¡œ</a>
    {% else %}
      <a href="{{ dues_on_url }}" class="btn btn-red">ë¯¸ë‚©ëœ ì‘ì—…ë³´ê¸°</a>
    {% endif %}

    {% if spare == '1' %}
      <a href="{{ spare_off_url }}" class="btn chip on">ì´ì „ìœ¼ë¡œ</a>
    {% else %}
      <a href="{{ spare_on_url }}" class="btn chip">ìŠ¤í˜ì–´ë§Œ</a>
    {% endif %}

    {% if outsrc == '1' %}
      <a href="{{ outsrc_off_url }}" class="btn chip on">ì´ì „ìœ¼ë¡œ</a>
    {% else %}
      <a href="{{ outsrc_on_url }}" class="btn chip">ì™¸ì£¼ì‘ì—…ë§Œ</a>
    {% endif %}
  </div>

  <!-- ì¼ê´„ ì²˜ë¦¬ -->
  <form id="bulkForm" method="post" action="{{ url_for('bulk_action') }}">
    <input type="hidden" name="action" id="bulkAction" value="">
    <div class="bulk">
      <button type="button" class="btn btn-green" onclick="setBulk('complete')">ì„ íƒ ì™„ë£Œ</button>
      <button type="button" class="btn btn-red"   onclick="setBulk('delete')">ì„ íƒ ì‚­ì œ</button>
      <button type="button" class="btn btn-ghost" onclick="exportSelected()">ì„ íƒ ì—‘ì…€ë°›ê¸°</button>
      <button type="button" class="btn btn-ghost" onclick="clearSelection()">ì„ íƒ í•´ì œ</button>
      <span class="hint">ì²´í¬í•œ í•­ëª©ì—ë§Œ ì ìš©ë©ë‹ˆë‹¤. (ê²€ìƒ‰/í•„í„° ë³€ê²½ ì‹œì—ë„ ì„ íƒ ìœ ì§€)</span>
    </div>

    <div class="table-wrap">
      {% if jobs and jobs|length>0 %}
      <table>
        <colgroup>
          <col style="width:4%;">
          <col style="width:11%;">
          <col style="width:12%;">
          <col style="width:21%;">
          <col style="width:22%;">
          <col style="width:18%;">
          <col style="width:12%;">
        </colgroup>
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>ë‚ ì§œ</th>
            <th>ê¸°ì‚¬</th>
            <th>ì¥ë¹„(ëª…/ì°¨ëŸ‰ë²ˆí˜¸)</th>
            <th>ê±°ë˜ì²˜ / ê¸ˆì•¡</th>
            <th>ì§€ë¶ˆ ìƒíƒœ</th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody>
          {% for job in jobs %}
          {% set mname = job.machine_name or job.machine %}
          {% set mnum  = job.machine_number %}
          {% set malias = job.machine_alias %}
          {% set myear  = job.machine_year %}
          {% set amt = (job.amount_man if job.amount_man is defined else 0) | int %}
          <tr>
            <td><input type="checkbox" name="selected_jobs" value="{{ job._idx }}"></td>
            <td>{{ job.date }}</td>

            <td>
              {% set w = job.worker or '-' %}
              <span class="worker-name" title="{{ w }}">{{ w }}</span>
              {% if job.is_spare %}<span class="spare-badge">(ìŠ¤í˜ì–´)</span>{% endif %}
            </td>

            <td>
              <span class="ellipsis" title="{{ (mname or '-') ~ ((' / ' ~ mnum) if mnum else '') }}">
                {{ mname or '-' }}{% if mnum %} / {{ mnum }}{% endif %}
              </span>
            </td>

            <td>
              {% set owner  = job.client_primary or job.client or '-' %}
              {% set tenant = job.client_tenant or '' %}

              {% if tenant and tenant != owner %}
                <span class="ellipsis" title="{{ owner }} / {{ tenant }}">{{ owner }} / {{ tenant }}</span>
              {% else %}
                <span class="ellipsis" title="{{ owner }}">{{ owner }}</span>
              {% endif %}

              {% if amt > 0 %}
                <span class="price-chip" title="{{ amt }}ë§Œ">â‚©{{ amt }}ë§Œ</span>
              {% else %}
                <span class="price-missing">ê¸ˆì•¡ì„¤ì • X</span>
              {% endif %}

              {% set ot = job.outsource_type or 'none' %}
              {% if ot != 'none' %}
                {% set tagclass = 'tag-blue' if ot=='received' else 'tag-purple' %}
                <span class="{{ tagclass }}" title="{{ job.outsource_partner }} ({{ 'ë°›ìŒ' if ot=='received' else 'ì¤¬ìŒ' }})">ì™¸ì£¼</span>
              {% endif %}
            </td>

            <td id="paycell-{{ job._idx }}">
              {% set amount = (job.amount_man if job.amount_man is defined else 0) | int %}
              {% set paid   = (job.paid_amount_man if job.paid_amount_man is defined else 0) | int %}
              {% set remaining = amount - paid %}
              {% set pstatus = job.payment_status
                                or ('ë¯¸ì„¤ì •' if amount <= 0
                                    else ('ì™„ë‚©' if paid >= amount
                                          else ('ë¯¸ë‚©' if paid <= 0 else 'ë¶€ë¶„'))) %}
              <div class="pay-chips">
                {% if amount > 0 %}
                  <span class="price-chip">ì´ â‚©{{ amount }}ë§Œ</span>
                  <span class="price-chip" id="remain-{{ job._idx }}">ì”ì•¡ {{ remaining if remaining>0 else 0 }}ë§Œ</span>

                  {% set pclass = 'price-chip' %}
                  {% if pstatus == 'ë¶€ë¶„' %}{% set pclass = 'badge-partial' %}
                  {% elif pstatus == 'ë¯¸ë‚©' %}{% set pclass = 'badge-unpaid' %}
                  {% elif pstatus == 'ë¯¸ì„¤ì •' %}{% set pclass = 'price-missing' %}{% endif %}
                  <span class="{{ pclass }}" id="pstatus-{{ job._idx }}">{{ pstatus }}</span>
                {% else %}
                  <span class="price-missing" id="pstatus-{{ job._idx }}">ê¸ˆì•¡ ë¯¸ì„¤ì •</span>
                {% endif %}
              </div>

              {% if amount > 0 %}
              <div class="pay-actions">
                {% if pstatus == 'ì™„ë‚©' %}
                  <button type="button" class="btn btn-red"
                          data-index="{{ job._idx }}"
                          data-url="{{ url_for('payment_api', job_index=job._idx) }}"
                          onclick="toggleFullPaid(this, false)">ì™„ë‚©ì·¨ì†Œ</button>
                {% else %}
                  <button type="button" class="btn btn-green"
                          data-index="{{ job._idx }}"
                          data-url="{{ url_for('payment_api', job_index=job._idx) }}"
                          onclick="toggleFullPaid(this, true)">ì™„ë‚©</button>
                {% endif %}
                <button type="button" class="btn btn-ghost"
                        data-index="{{ job._idx }}"
                        data-url="{{ url_for('payment_api', job_index=job._idx) }}"
                        onclick="partialPaid(this)">ë¶€ë¶„ì™„ë‚©</button>
              </div>
              {% endif %}
            </td>

            <td style="display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap;">
              <span id="status-{{ job._idx }}" class="status {{ 'done' if job.status=='ì™„ë£Œ' else 'todo' }}">
                {{ job.status or 'ì§„í–‰ì¤‘' }}
              </span>

              <button type="button" class="arrow" data-target="d-{{ loop.index0 }}">â–¼</button>

              <button type="button" class="btn btn-ghost status-toggle"
                      data-index="{{ job._idx }}"
                      data-url="{{ url_for('toggle_complete_api', job_index=job._idx) }}"
                      onclick="toggleStatus(this)">
                {% if job.status=='ì™„ë£Œ' %}ì™„ë£Œì·¨ì†Œ{% else %}ì™„ë£Œ{% endif %}
              </button>
            </td>
          </tr>

          <tr id="d-{{ loop.index0 }}" class="detail-row">
            <td colspan="7">
              <div class="detail">
                <div>
                  <b>ì¥ë¹„:</b>
                  {{ mname or '-' }}{% if mnum %} / {{ mnum }}{% endif %}
                  {% if malias %} / <span style="color:#6b7280;">{{ malias }}</span>{% endif %}
                  {% if myear  %} / <span style="color:#6b7280;">{{ myear }}</span>{% endif %}
                </div>
                <div>
                  <b>ìœ„ì¹˜:</b>
                  {{ job.location or '-' }}
                  {% if job.location %}
                    <span class="copy-link" onclick="copyToClipboard(`{{ (job.location or '')|replace('`','\\`') }}`)">ë³µì‚¬</span>
                  {% endif %}
                </div>
                <div style="grid-column:1 / -1;"><b>ìš”ì²­ì‚¬í•­:</b> {{ job.note or '-' }}</div>
                <div><b>ë°œì£¼/ì„ì°¨:</b> {{ owner }}{% if tenant %} / {{ tenant }}{% endif %}</div>
                <div><b>ì™¸ì£¼ë‚´ì—­:</b>
                  {% set ot = job.outsource_type or 'none' %}
                  {% if ot != 'none' %}
                    {{ job.outsource_partner or '-' }} ({{ 'ë°›ìŒ' if ot=='received' else 'ì¤¬ìŒ' }})
                  {% else %}-{% endif %}
                </div>
                <div class="detail-actions">
                  <a href="{{ url_for('edit_job', job_index=job._idx) }}" class="btn btn-blue">ìˆ˜ì •</a>
                  <a href="{{ url_for('delete_job', job_index=job._idx) }}" class="btn btn-red" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</a>
                  <button type="button" class="btn btn-green status-toggle"
                          data-index="{{ job._idx }}"
                          data-url="{{ url_for('toggle_complete_api', job_index=job._idx) }}"
                          onclick="toggleStatus(this)">
                    {% if job.status=='ì™„ë£Œ' %}ì™„ë£Œì·¨ì†Œ{% else %}ì™„ë£Œ{% endif %}
                  </button>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div style="padding:24px; text-align:center;">ë“±ë¡ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      {% endif %}
    </div>
  </form>

  <div style="display:flex; justify-content:center; margin:18px 0;">
    <form action="{{ url_for('dashboard') }}">
        <button type="submit" style="font-size: 16px;">ğŸ  ë©”ì¸í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </form>
  </div>
</body>
</html>
