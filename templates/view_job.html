<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì „ì²´ ì‘ì—… ëª©ë¡</title>
  <style>
    :root{
      --gap:12px; --radius:10px; --border:#e5e7eb; --bg:#f7f7f9; --muted:#6b7280;
      --blue:#1e90ff; --green:#22c55e; --red:#ef4444;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'ë§‘ì€ ê³ ë”•',sans-serif; max-width:1080px; margin:36px auto; padding:0 16px; background:#fafafa;}
    h2{font-size:26px; font-weight:800; text-align:center; margin:0 0 18px;}

    .toolbar{display:flex; flex-wrap:wrap; align-items:center; gap:var(--gap); justify-content:center; margin-bottom:8px;}
    .toolbar input{padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:14px; min-width:210px; background:#fff;}
    .btn{display:inline-flex; align-items:center; gap:6px; border:none; border-radius:8px; padding:10px 14px; font-size:14px; cursor:pointer; text-decoration:none;}
    .btn-blue{background:var(--blue); color:#fff;}
    .btn-ghost{background:#eef2f7; color:#334155;}
    .btn-green{background:var(--green); color:#fff;}
    .btn-red{background:var(--red); color:#fff;}
    .chip{background:#9ca3af; color:#fff;} .chip.on{background:#f59e0b;}

    .calendar-wrap{display:flex; justify-content:center; margin: 10px 0 16px;}
    .bulk{display:flex; gap:10px; align-items:center; margin: 6px 0 14px;}
    .hint{color:var(--muted); font-size:13px;}

    .table-wrap{background:#fff; border-radius:var(--radius); border:1px solid var(--border); overflow:hidden;}
    table{width:100%; border-collapse:collapse; table-layout:fixed;}
    th,td{padding:14px 12px; text-align:center; border-bottom:1px solid var(--border);}
    th{background:#f3f4f6; font-weight:700;}
    tr:hover td{background:#fbfcff;}
    .arrow{padding:8px 10px; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer;}
    .status{font-weight:700;}
    .done{color:#16a34a;} .todo{color:#334155;}

    .detail-row{display:none;}
    .detail{background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:14px; margin:8px; display:grid; grid-template-columns:1fr 1fr; gap:10px 18px; text-align:left;}
    .detail-actions{grid-column:1 / -1; display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;}

    .ellipsis{display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .copy-link{font-size:12px; text-decoration:underline; cursor:pointer; color:#2563eb;}
    .price-chip{display:inline-block; margin-left:6px; padding:2px 6px; border-radius:8px; background:#eef2f7; font-size:12px; vertical-align:middle;}
    .price-missing{display:inline-block; margin-left:6px; padding:2px 6px; border-radius:8px; background:#fff1f2; color:#b91c1c; font-size:12px; vertical-align:middle;}

    @media (max-width:720px){ .detail{grid-template-columns:1fr;} .toolbar input{min-width:140px;} }
  </style>
</head>
<body>
  <h2>ì „ì²´ ì‘ì—… ëª©ë¡</h2>

  <!-- ê²€ìƒ‰/í•„í„° -->
  <form class="toolbar" method="get" action="{{ url_for('view_jobs') }}">
    <input type="text"  name="worker" placeholder="ê¸°ì‚¬ëª…"  value="{{ request.args.get('worker','') }}">
    <input type="text"  name="client" placeholder="ê±°ë˜ì²˜" value="{{ request.args.get('client','') }}">
    <input type="date"  name="date"   value="{{ request.args.get('date','') }}">
    <button type="submit" class="btn btn-blue">ê²€ìƒ‰</button>
    <a href="{{ url_for('view_jobs') }}" class="btn btn-ghost">ì´ˆê¸°í™”</a>
    {% if overdue == '1' %}
      <a href="{{ overdue_off_url }}" class="btn chip on">ì „ì²´ë³´ê¸°</a>
    {% else %}
      <a href="{{ overdue_on_url }}" class="btn chip">ë¯¸ìˆ˜ì‘ì—…ë§Œ</a>
    {% endif %}
  </form>

  <!-- ìº˜ë¦°ë” -->
  <div class="calendar-wrap">
    <a href="{{ url_for('calendar_view') }}" class="btn btn-green">ğŸ“… ìº˜ë¦°ë” ë³´ê¸°</a>
  </div>

  <!-- ì¼ê´„ ì²˜ë¦¬ -->
  <form id="bulkForm" method="post" action="{{ url_for('bulk_action') }}">
    <input type="hidden" name="action" id="bulkAction" value="">
    <div class="bulk">
      <button type="button" class="btn btn-green" onclick="setBulk('complete')">ì„ íƒ ì™„ë£Œ</button>
      <button type="button" class="btn btn-red"   onclick="setBulk('delete')">ì„ íƒ ì‚­ì œ</button>
      <span class="hint">ì²´í¬í•œ í•­ëª©ì—ë§Œ ì ìš©ë©ë‹ˆë‹¤.</span>
    </div>

    <div class="table-wrap">
      {% if jobs and jobs|length>0 %}
      <table>
        <colgroup>
          <col style="width:48px;">   <!-- ì²´í¬ -->
          <col style="width:110px;">  <!-- ë‚ ì§œ -->
          <col style="width:140px;">  <!-- ê¸°ì‚¬ -->
          <col style="width:210px;">  <!-- ì¥ë¹„ -->
          <col style="width:200px;">  <!-- ê±°ë˜ì²˜(+ê¸ˆì•¡) -->
          <col style="width:100px;">  <!-- ìƒíƒœ -->
          <col style="width:220px;">  <!-- ê´€ë¦¬ -->
        </colgroup>
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>ë‚ ì§œ</th>
            <th>ê¸°ì‚¬</th>
            <th>ì¥ë¹„(ëª…/ì°¨ëŸ‰ë²ˆí˜¸)</th>
            <th>ê±°ë˜ì²˜ / ê¸ˆì•¡</th>
            <th>ìƒíƒœ</th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody>
          {% for job in jobs %}
          {% set mname = job.machine_name or job.machine %}
          {% set mnum  = job.machine_number %}
          {% set malias = job.machine_alias %}
          {% set myear  = job.machine_year %}
          {% set amt = (job.amount_man if job.amount_man is defined else 0) | int %}
          <tr>
            <td><input type="checkbox" name="selected_jobs" value="{{ job._idx }}"></td>
            <td>{{ job.date }}</td>
            <td><span class="ellipsis" title="{{ job.worker }}">{{ job.worker }}</span></td>
            <td>
              <span class="ellipsis" title="{{ (mname or '-') ~ ((' / ' ~ mnum) if mnum else '') }}">
                {{ mname or '-' }}{% if mnum %} / {{ mnum }}{% endif %}
              </span>
            </td>
            <td>
              {% set client = job.client or '-' %}
              <span class="ellipsis" title="{{ client }}">{{ client }}</span>
              {% if amt > 0 %}
                <span class="price-chip" title="{{ amt }}ë§Œ">â‚©{{ amt }}ë§Œ</span>
              {% else %}
                <span class="price-missing">ê¸ˆì•¡ì„¤ì • X</span>
              {% endif %}
            </td>
            <td id="status-{{ job._idx }}" class="status {{ 'done' if job.status=='ì™„ë£Œ' else 'todo' }}">{{ job.status or 'ì§„í–‰ì¤‘' }}</td>
            <td style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
              <button type="button" class="arrow" data-target="d-{{ loop.index0 }}">â–¼</button>
              <button type="button" class="btn btn-ghost"
                      data-index="{{ job._idx }}"
                      data-url="{{ url_for('toggle_complete_api', job_index=job._idx) }}"
                      onclick="toggleStatus(this)">
                {% if job.status=='ì™„ë£Œ' %}ì™„ë£Œì·¨ì†Œ{% else %}ì™„ë£Œ{% endif %}
              </button>
            </td>
          </tr>
          <tr id="d-{{ loop.index0 }}" class="detail-row">
            <td colspan="7">
              <div class="detail">
                <div>
                  <b>ì¥ë¹„:</b>
                  {{ mname or '-' }}{% if mnum %} / {{ mnum }}{% endif %}
                  {% if malias %} / <span style="color:#6b7280;">{{ malias }}</span>{% endif %}
                  {% if myear  %} / <span style="color:#6b7280;">{{ myear }}</span>{% endif %}
                </div>
                <div><b>ìœ„ì¹˜:</b> {{ job.location or '-' }} {% if job.location %}<span class="copy-link" onclick="copyToClipboard(`{{ job.location }}`)">ë³µì‚¬</span>{% endif %}</div>
                <div style="grid-column:1 / -1;"><b>ìš”ì²­ì‚¬í•­:</b> {{ job.note or '-' }}</div>
                <div class="detail-actions">
                  <a href="{{ url_for('edit_job', job_index=job._idx) }}" class="btn btn-blue">ìˆ˜ì •</a>
                  <a href="{{ url_for('delete_job', job_index=job._idx) }}" class="btn btn-red" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</a>
                  <button type="button" class="btn btn-green"
                          data-index="{{ job._idx }}"
                          data-url="{{ url_for('toggle_complete_api', job_index=job._idx) }}"
                          onclick="toggleStatus(this)">
                    {% if job.status=='ì™„ë£Œ' %}ì™„ë£Œì·¨ì†Œ{% else %}ì™„ë£Œ{% endif %}
                  </button>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div style="padding:24px; text-align:center;">ë“±ë¡ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      {% endif %}
    </div>
  </form>

  <div style="display:flex; justify-content:center; margin:18px 0;">
    <a class="btn btn-ghost" href="{{ url_for('dashboard') }}">ğŸ  ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <script>
    // ì „ì²´ ì„ íƒ
    document.getElementById('selectAll')?.addEventListener('change', function(){
      document.querySelectorAll('input[name="selected_jobs"]').forEach(cb => cb.checked = this.checked);
    });

    // ìƒì„¸ í¼ì¹¨
    document.querySelectorAll('.arrow').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.target;
        const row = document.getElementById(id);
        const open = row.style.display === 'table-row';
        row.style.display = open ? 'none' : 'table-row';
        btn.textContent = open ? 'â–¼' : 'â–²';
      });
    });

    // ì¼ê´„ ì²˜ë¦¬
    function setBulk(action){
      if(action==='delete' && !confirm('ì„ íƒí•œ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      document.getElementById('bulkAction').value = action;
      document.getElementById('bulkForm').submit();
    }

    function copyToClipboard(text){
      navigator.clipboard.writeText(text).then(()=>{ alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + text); });
    }

    // ìƒíƒœ í† ê¸€
    async function toggleStatus(btn){
      const idx = btn.dataset.index;
      const url = btn.dataset.url;
      try{
        const res = await fetch(url,{method:'POST',headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'},credentials:'same-origin'});
        if(res.redirected){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); location.href=res.url; return; }
        const data = await res.json();
        if(!res.ok||!data?.success){ alert('ë³€ê²½ ì‹¤íŒ¨: '+(data?.error||res.status)); return; }
        const cell=document.getElementById('status-'+idx);
        if(cell){ cell.textContent=data.status||''; cell.classList.toggle('done',data.status==='ì™„ë£Œ'); cell.classList.toggle('todo',data.status!=='ì™„ë£Œ'); }
        document.querySelectorAll(`button[data-index="${idx}"]`).forEach(b=>{ b.textContent = (data.status==='ì™„ë£Œ') ? 'ì™„ë£Œì·¨ì†Œ' : 'ì™„ë£Œ'; });
      }catch(err){ alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'); }
    }
  </script>
</body>
</html>
