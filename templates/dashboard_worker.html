<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‚´ ì‘ì—… ëª©ë¡</title>
  <style>
    :root{
      --gap:12px; --radius:10px; --border:#e5e7eb; --bg:#f7f7f9; --muted:#6b7280;
      --blue:#1e90ff; --green:#22c55e; --red:#ef4444;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'ë§‘ì€ ê³ ë”•',sans-serif; max-width:1080px; margin:36px auto; padding:0 16px; background:#fafafa;}
    h2{font-size:26px; font-weight:800; text-align:center; margin:0 0 18px;}

    .toolbar{display:flex; flex-wrap:wrap; align-items:center; gap:var(--gap); justify-content:center; margin-bottom:8px;}
    .toolbar input{padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:14px; min-width:210px; background:#fff;}
    .btn{display:inline-flex; align-items:center; gap:6px; border:none; border-radius:8px; padding:10px 14px; font-size:14px; cursor:pointer; text-decoration:none;}
    .btn-blue{background:var(--blue); color:#fff;}
    .btn-ghost{background:#eef2f7; color:#334155;}
    .btn-green{background:var(--green); color:#fff;}
    .btn-red{background:var(--red); color:#fff;}

    .calendar-wrap{display:flex; justify-content:center; margin: 10px 0 16px;}

    .table-wrap{background:#fff; border-radius:var(--radius); border:1px solid var(--border); overflow:hidden;}
    table{width:100%; border-collapse:collapse; table-layout:fixed;}
    th,td{padding:14px 12px; text-align:center; border-bottom:1px solid var(--border);}
    th{background:#f3f4f6; font-weight:700;}
    tr:hover td{background:#fbfcff;}
    .arrow{padding:8px 10px; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer;}
    .status{font-weight:700;}
    .done{color:#16a34a;} .todo{color:#334155;}

    .detail-row{display:none;}
    .detail{background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:14px; margin:8px; display:grid; grid-template-columns:1fr 1fr; gap:10px 18px; text-align:left;}
    .detail-actions{grid-column:1 / -1; display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;}

    .ellipsis{display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .copy-link{font-size:12px; text-decoration:underline; cursor:pointer; color:#2563eb;}
    .price-chip{display:inline-block; margin-left:6px; padding:2px 6px; border-radius:8px; background:#eef2f7; font-size:12px; vertical-align:middle;}
    .price-missing{display:inline-block; margin-left:6px; padding:2px 6px; border-radius:8px; background:#fff1f2; color:#b91c1c; font-size:12px; vertical-align:middle;}

    @media (max-width:720px){ .detail{grid-template-columns:1fr;} .toolbar input{min-width:140px;} }
  </style>
</head>
<body>
  <h2>ë‚´ ì‘ì—… ëª©ë¡</h2>

  <!-- ê²€ìƒ‰/í•„í„° (ê¸°ì‚¬ìš©: ê±°ë˜ì²˜/ë‚ ì§œ) -->
  <form class="toolbar" method="get" action="{{ url_for('dashboard_worker') }}">
    <input type="text"  name="client" placeholder="ê±°ë˜ì²˜" value="{{ request.args.get('client','') }}">
    <input type="date"  name="date"                   value="{{ request.args.get('date','') }}">
    <button type="submit" class="btn btn-blue">ê²€ìƒ‰</button>
    <a href="{{ url_for('dashboard_worker') }}" class="btn btn-ghost">ì´ˆê¸°í™”</a>
  </form>

  <!-- ìº˜ë¦°ë” ë³´ê¸° -->
  <div class="calendar-wrap">
    <a href="{{ url_for('calendar_view') }}" class="btn btn-green">ğŸ“… ìº˜ë¦°ë” ë³´ê¸°</a>
  </div>

  <div class="table-wrap">
    {% if jobs and jobs|length>0 %}
    <table>
      <colgroup>
        <col style="width:110px;">  <!-- ë‚ ì§œ -->
        <col style="width:80px;">   <!-- ì‹œê°„ -->
        <col style="width:220px;">  <!-- ì¥ë¹„ -->
        <col style="width:260px;">  <!-- ìœ„ì¹˜ -->
        <col style="width:200px;">  <!-- ê±°ë˜ì²˜(+ê¸ˆì•¡ or ê¸ˆì•¡ì„¤ì •X) -->
        <col style="width:100px;">  <!-- ìƒíƒœ -->
        <col style="width:220px;">  <!-- ê´€ë¦¬ -->
      </colgroup>
      <thead>
        <tr>
          <th>ë‚ ì§œ</th><th>ì‹œê°„</th><th>ì¥ë¹„(ëª…/ì°¨ëŸ‰ë²ˆí˜¸)</th><th>ìœ„ì¹˜</th><th>ê±°ë˜ì²˜ / ê¸ˆì•¡</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th>
        </tr>
      </thead>
      <tbody>
        {% for job in jobs %}
        {% set idx = job._idx if job._idx is defined else loop.index0 %}
        {% set mname = job.machine_name or job.machine %}
        {% set mnum  = job.machine_number %}
        {% set malias = job.machine_alias %}
        {% set myear  = job.machine_year %}
        {% set amt = (job.amount_man if job.amount_man is defined else 0) | int %}
        <tr>
          <td>{{ job.date }}</td>
          <td>{{ job.time or '-' }}</td>

          <td>
            <span class="ellipsis" title="{{ (mname or '-') ~ ((' / ' ~ mnum) if mnum else '') }}">
              {{ mname or '-' }}{% if mnum %} / {{ mnum }}{% endif %}
            </span>
          </td>

          <td>
            {% set loc = job.location or '-' %}
            <span class="ellipsis" title="{{ loc }}">{{ loc }}</span>
            {% if job.location %}
              <span class="copy-link" onclick="copyToClipboard(`{{ job.location|replace('`','\\`') }}`)">ë³µì‚¬</span>
            {% endif %}
          </td>

          <td>
            {% set client = job.client or '-' %}
            <span class="ellipsis" title="{{ client }}">{{ client }}</span>
            {% if job.share_amount and amt > 0 %}
              <span class="price-chip" title="{{ amt }}ë§Œ">â‚©{{ amt }}ë§Œ</span>
            {% else %}
              <span class="price-missing">ê¸ˆì•¡ì„¤ì • X</span>
            {% endif %}
          </td>

          <td id="status-{{ idx }}" class="status {{ 'done' if job.status=='ì™„ë£Œ' else 'todo' }}">{{ job.status or 'ì§„í–‰ì¤‘' }}</td>

          <td style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
            <button type="button" class="arrow" data-target="d-{{ loop.index0 }}">â–¼</button>
            <button type="button" class="btn btn-ghost"
                    data-index="{{ idx }}"
                    data-url="{{ url_for('toggle_complete_api', job_index=idx) }}"
                    onclick="toggleStatus(this)">
              {% if job.status=='ì™„ë£Œ' %}ì™„ë£Œì·¨ì†Œ{% else %}ì™„ë£Œ{% endif %}
            </button>
            <a href="{{ url_for('edit_job', job_index=idx) }}" class="btn btn-blue">ìˆ˜ì •</a>
          </td>
        </tr>

        <tr id="d-{{ loop.index0 }}" class="detail-row">
          <td colspan="7">
            <div class="detail">
              <div>
                <b>ì¥ë¹„:</b>
                {{ mname or '-' }}{% if mnum %} / {{ mnum }}{% endif %}
                {% if malias %} / <span style="color:#6b7280;">{{ malias }}</span>{% endif %}
                {% if myear  %} / <span style="color:#6b7280;">{{ myear }}</span>{% endif %}
              </div>
              <div><b>ê¸°ê°„:</b>
                {% if job.duration_type == 'Nì‹œê°„' %}
                  {{ job.duration_hours }}ì‹œê°„
                {% elif job.duration_type == 'ë°˜ë‚˜ì ˆ' %}
                  ë°˜ë‚˜ì ˆ
                {% else %}
                  í•˜ë£¨
                {% endif %}
              </div>
              <div><b>ìœ„ì¹˜:</b>
                {{ job.location or '-' }}
                {% if job.location %}
                  <span class="copy-link" onclick="copyToClipboard(`{{ job.location|replace('`','\\`') }}`)">ë³µì‚¬</span>
                {% endif %}
              </div>
              <div><b>ê±°ë˜ì²˜:</b> {{ job.client or '-' }}</div>
              <div style="grid-column:1 / -1;"><b>ìš”ì²­ì‚¬í•­:</b> {{ job.note or '-' }}</div>

              <div class="detail-actions">
                <a href="{{ url_for('edit_job', job_index=idx) }}" class="btn btn-blue">ìˆ˜ì •</a>
                <button type="button" class="btn btn-green"
                        data-index="{{ idx }}"
                        data-url="{{ url_for('toggle_complete_api', job_index=idx) }}"
                        onclick="toggleStatus(this)">
                  {% if job.status=='ì™„ë£Œ' %}ì™„ë£Œì·¨ì†Œ{% else %}ì™„ë£Œ{% endif %}
                </button>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <div style="padding:24px; text-align:center;">í• ë‹¹ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    {% endif %}
  </div>

  <div style="display:flex; justify-content:center; margin:18px 0; gap:10px;">
    <a class="btn btn-ghost" href="{{ url_for('dashboard') }}">ğŸ  ëŒ€ì‹œë³´ë“œ</a>
    <a class="btn btn-blue"  href="{{ url_for('edit_worker') }}">ë‚´ ì •ë³´ ìˆ˜ì •</a>
    <form action="{{ url_for('logout') }}" method="post" style="display:inline;">
      <button type="submit" class="btn btn-red">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </form>
  </div>

  <script>
    // ìƒì„¸ í¼ì¹¨
    document.querySelectorAll('.arrow').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.target;
        const row = document.getElementById(id);
        const open = row.style.display === 'table-row';
        row.style.display = open ? 'none' : 'table-row';
        btn.textContent = open ? 'â–¼' : 'â–²';
      });
    });

    // ë³µì‚¬
    function copyToClipboard(text){
      navigator.clipboard.writeText(text).then(()=>{
        alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + text);
      }).catch(()=>{
        alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      });
    }

    // ìƒíƒœ í† ê¸€(AJAX)
    async function toggleStatus(btn){
      const idx = btn.dataset.index;
      const url = btn.dataset.url;

      try{
        const res = await fetch(url, {
          method:'POST',
          headers:{ 'X-Requested-With':'XMLHttpRequest', 'Accept':'application/json' },
          credentials:'same-origin'
        });

        if (res.redirected){
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          location.href = res.url;
          return;
        }

        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')){
          if (res.status === 401){
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            location.href = "{{ url_for('login') }}";
          } else {
            const html = await res.text();
            console.error('Non-JSON response:', res.status, html);
            alert('ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
          return;
        }

        const data = await res.json();
        if(!res.ok || !data?.success){
          alert('ë³€ê²½ ì‹¤íŒ¨: ' + (data?.error || res.status));
          return;
        }

        // ìƒíƒœ ì…€ ê°±ì‹ 
        const cell = document.getElementById('status-'+idx);
        if(cell){
          cell.textContent = data.status || '';
          cell.classList.toggle('done', data.status==='ì™„ë£Œ');
          cell.classList.toggle('todo', data.status!=='ì™„ë£Œ');
        }
        // ë™ì¼ ì¸ë±ìŠ¤ ë²„íŠ¼ ë¼ë²¨ ë™ê¸°í™”
        document.querySelectorAll(`button[data-index="${idx}"]`).forEach(b=>{
          b.textContent = (data.status==='ì™„ë£Œ') ? 'ì™„ë£Œì·¨ì†Œ' : 'ì™„ë£Œ';
        });

      }catch(err){
        console.error(err);
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      }
    }
  </script>
</body>
</html>
